BACKUP ~weidu_external/backup/faiths_and_powers~
AUTHOR ~SubtleD and Grammarsalad~


VERSION ~0.91.1~


//README ~faiths_and_powers/readme-pnp.html~


ASK_EVERY_COMPONENT


ALWAYS

	ACTION_IF GAME_IS ~iwdee~ BEGIN
	  ACTION_IF FILE_EXISTS_IN_GAME ~#bonecir.spl~ BEGIN
		COPY_EXISTING ~sppr101.spl~ ~override/#bonecir.spl~
	  END
	END
  	OUTER_SPRINT ~mod_folder~ ~faiths_and_powers~
        OUTER_SPRINT ~folder~ ~faiths_and_powers~
	ACTION_IF !(FILE_EXISTS ~override/d5_fnp_settings.ini~) BEGIN
  	  COPY ~faiths_and_powers/d5_fnp_settings.ini~ ~override~
	END
   	INCLUDE ~override/d5_fnp_settings.ini~
  	
	INCLUDE ~faiths_and_powers/lib/effect_return.tpa~
	INCLUDE ~faiths_and_powers/lib/item_in_store.tpa~

	INCLUDE ~faiths_and_powers/lib/spell_evasion.tpa~
	INCLUDE ~faiths_and_powers/lib/bg2fp_effect_batches_fnp.tpa~
//	INCLUDE ~faiths_and_powers/lib/bg2fp_effect_batches.tpa~
	INCLUDE ~faiths_and_powers/lib/fl#add_kit_ee.tpa~
	INCLUDE ~faiths_and_powers/lib/a7#add_kit_ex.tpa~
	INCLUDE ~faiths_and_powers/lib/qd_multiclass.tpa~
	INCLUDE ~faiths_and_powers/lib/system_misc_functions.tpa~
	INCLUDE ~faiths_and_powers/lib/system_base.tpa~
	INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~
	INCLUDE ~faiths_and_powers/lib/system_fnp_spontaneous.tpa~
	DEFINE_ACTION_MACRO d5_minor_access_levels BEGIN
	  OUTER_SET d5_minor_shift = 0
	END
	
	LAF fix_kitlist_missing_ids END

	ACTION_IF FILE_EXISTS_IN_GAME ~a#ooze.2da~ BEGIN
	  COPY_EXISTING ~alignmnt.2da~ ~override~
		REPLACE_TEXTUALLY ~DRUID.+$~ ~DRUID	0	1	0	1	1	1	0	1	0 ~
		REPLACE_TEXTUALLY ~FIGHTER_DRUID.+$~ ~FIGHTER_DRUID	0	1	0	1	1	1	0	1	0 ~
		REPLACE_TEXTUALLY ~TOTEMIC_DRUID.+$~ ~TOTEMIC_DRUID	0	1	0	1	1	1	0	1	0 ~
		REPLACE_TEXTUALLY ~SHAPESHIFTER.+$~ ~SHAPESHIFTER	0	1	0	1	1	1	0	1	0 ~
		REPLACE_TEXTUALLY ~BEAST_FRIEND.+$~ ~BEAST_FRIEND	0	1	0	1	1	1	0	1	0 ~
	END

	COPY ~faiths_and_powers/kits/clerics/B_LOR.spl~ ~override~

// joinable NPC issues for tutu/bgt/eet:
  ACTION_IF GAME_IS ~bgee~ BEGIN
    OUTER_SPRINT tutu_var ~~
    OUTER_SPRINT imoen6_var ~imoen6~
    OUTER_SPRINT jaheir7_var ~jaheir7~
    OUTER_SPRINT minsc7_var ~minsc7~
    OUTER_SPRINT quayle_var ~quayle~
    OUTER_SPRINT viconi6_var ~viconi6~
    OUTER_SPRINT xan_var ~xan~
    OUTER_SPRINT xzar_var ~xzar~
  END
  ACTION_IF GAME_IS ~eet~ BEGIN
    OUTER_SPRINT tutu_var ~~
    OUTER_SPRINT imoen6_var ~imoen6_~
    OUTER_SPRINT jaheir7_var ~jaheir7_~
    OUTER_SPRINT minsc7_var ~minsc7_~
    OUTER_SPRINT quayle_var ~quayle_~
    OUTER_SPRINT viconi6_var ~viconi6_~
    OUTER_SPRINT xan_var ~xan_~
    OUTER_SPRINT xzar_var ~xzar_~
  END

END

// ASK_EVERY_COMPONENT

LANGUAGE
  ~English~
  ~english~
  ~faiths_and_powers/language/english/setup.tra~
  ~faiths_and_powers/language/english/fnp_spontaneous.tra~
  ~faiths_and_powers/language/english/IWD_spells.tra~
  ~faiths_and_powers/language/english/new_spells.tra~
  ~faiths_and_powers/language/english/HLA.tra~
LANGUAGE
  ~French~
  ~french~
  ~faiths_and_powers/language/french/setup.tra~
  ~faiths_and_powers/language/french/fnp_spontaneous.tra~
  ~faiths_and_powers/language/french/IWD_spells.tra~
  ~faiths_and_powers/language/french/new_spells.tra~
  ~faiths_and_powers/language/french/HLA.tra~
//___________________________________________________________________________________


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////

//__________________________________________________________________________________
//__________________________________________________________________________________
//
BEGIN @12 // revised cleric spell table
DESIGNATED 12
SUBCOMPONENT @11 
LABEL ~D5_FNP_CLERIC_SPELL_TABLE~

COPY  ~faiths_and_powers/data/misc/mxsplprs_fnp.2da~ ~override/mxsplprs.2da~
//__________________________________________________________________________________

BEGIN @13 // unnerfed cleric spell table
DESIGNATED 13
SUBCOMPONENT @11 
LABEL ~D5_UNNERFED_CLERIC_SPELL_TABLE~

COPY  ~faiths_and_powers/data/misc/mxsplprs_un.2da~ ~override/mxsplprs.2da~
//__________________________________________________________________________________


//__________________________________________________________________________________
//__________________________________________________________________________________
//
BEGIN @15 // druids use cleric spell & XP tables
DESIGNATED 15
LABEL ~D5_DRUID_ON_CLERIC_TABLES~

LAF druid_xp END
//__________________________________________________________________________________


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////

//__________________________________________________________________________________
//__________________________________________________________________________________
//
//								CHOOSE SPHERE SYSTEM
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @21 // FnP original sphere system
DESIGNATED 21
SUBCOMPONENT @20 
LABEL ~D5_FNP_SPHERE_SYSTEM~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__spheres.d5~
COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__fnp_spheres.d5~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  MOVE ~override/fnp_sphere_list.tpa~ ~weidu_external/faiths_and_powers/fnp_sphere_list_old.tpa~
END

//prep sphere system________________________________________________________________
//
COPY ~faiths_and_powers/data/sphere_systems/sphere_list_fnp.tpa~ ~override/fnp_sphere_list.tpa~

//change shaman known spells________________________________________________________
//
//LAF shaman_spells END
//... nope, fold this into the d5_spontaneous function

//Add IWD and new spells____________________________________________________________
//
LAM d5_spell_options

ACTION_CLEAR_ARRAY aoe_spell

ACTION_IF (include_new_FNP_spells = 1) BEGIN
  INCLUDE ~faiths_and_powers/lib/spells_new_v75.tpa~      	//includes spells from the 0.75 series  
  INCLUDE ~faiths_and_powers/lib/spells_new_fnp.tpa~   		//new spells from the 0.77 series 
  LAM v78_add_FnP_new_spells
END

ACTION_IF !(GAME_IS ~iwdee~) BEGIN
  ACTION_IF (include_IWD_arcane_spells = 1) BEGIN
    LAM v75_add_iwd_arcane_spells
  END
  ACTION_IF (include_IWD_divine_spells = 1) BEGIN
    LAM v75_add_iwd_divine_spells
  END
END

ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
  LAM v75_apply_sr_aoe_deflection
END  

LAF fix_spell_bams END
// ***** ^^ make this fix summoning spells if IWD+SR installed?

COPY ~faiths_and_powers/data/hlas/system_FnP/~ ~weidu_external/faiths_and_powers/hlas~

//INCLUDE ~%mod_folder%/lib/immunities.tpa~					//	DO AT THE VERY END OF ALL SPELL INSTALLS

INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~

 LAF prep_vanilla_spells END

INCLUDE ~override/fnp_sphere_list.tpa~
 LAM define_sphere_names
 LAM d5_define_sphere_spells
 LAM d5_deity_kit_sphere_lists

LAF create_spheres END

//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @22 // 2E-style sphere system
DESIGNATED 22
SUBCOMPONENT @20
LABEL ~D5_PNP_SPHERE_SYSTEM~

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__spheres.d5~
COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__2e_spheres.d5~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  MOVE ~override/fnp_sphere_list.tpa~ ~override/fnp_sphere_list_old.tpa~
END

//prep sphere system________________________________________________________________
//
COPY ~faiths_and_powers/data/sphere_systems/sphere_list_2E.tpa~ ~override/fnp_sphere_list.tpa~

//Add IWD and new spells____________________________________________________________
//
LAM d5_spell_options

ACTION_CLEAR_ARRAY aoe_spell

ACTION_IF (include_new_FNP_spells = 1) BEGIN
  INCLUDE ~faiths_and_powers/lib/spells_new_v75.tpa~      	//includes spells from the 0.75 series  
  INCLUDE ~faiths_and_powers/lib/spells_new_fnp.tpa~   		//new spells from the 0.77 series 
  LAM v78_add_FnP_new_spells
END

ACTION_IF !(GAME_IS ~iwdee~) BEGIN
  ACTION_IF (include_IWD_arcane_spells = 1) BEGIN
    LAM v75_add_iwd_arcane_spells
  END
  ACTION_IF (include_IWD_divine_spells = 1) BEGIN
    LAM v75_add_iwd_divine_spells
  END
END

ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
  LAM v75_apply_sr_aoe_deflection
END  

LAF fix_spell_bams END

COPY ~faiths_and_powers/data/hlas/system_2E/~ ~weidu_external/faiths_and_powers/hlas~

//INCLUDE ~%mod_folder%/lib/immunities.tpa~					//	DO AT THE VERY END OF ALL SPELL INSTALLS

//create sphere system______________________________________________________________
//
INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~

 LAF prep_vanilla_spells END

INCLUDE ~override/fnp_sphere_list.tpa~
 LAM define_sphere_names
 LAM d5_define_sphere_spells
 LAM d5_deity_kit_sphere_lists

LAF create_spheres END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @23 // mostly vanilla - same as unmodded game, but kits can cross the cleric/druid divide
DESIGNATED 23
SUBCOMPONENT @20 
LABEL ~D5_VANILLA_SPHERE_SYSTEM~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__spheres.d5~
COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__vanilla_spheres.d5~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  MOVE ~override/fnp_sphere_list.tpa~ ~weidu_external/faiths_and_powers/fnp_sphere_list_old.tpa~
END

//prep sphere system________________________________________________________________
//
COPY ~faiths_and_powers/data/sphere_systems/sphere_list_vanilla.tpa~ ~override/fnp_sphere_list.tpa~

//Add IWD and new spells____________________________________________________________
//
LAM d5_spell_options

ACTION_CLEAR_ARRAY aoe_spell

ACTION_IF (include_new_FNP_spells = 1) BEGIN
  INCLUDE ~faiths_and_powers/lib/spells_new_v75.tpa~      	//includes spells from the 0.75 series  
  INCLUDE ~faiths_and_powers/lib/spells_new_fnp.tpa~   		//new spells from the 0.77 series 
//  LAM v75_add_fnP_new_spells
  LAM v78_add_FnP_new_spells
END

/* no need for this if using vanilla spell system
ACTION_IF !(GAME_IS ~iwdee~) BEGIN
  ACTION_IF (include_IWD_arcane_spells = 1) BEGIN
    LAM v75_add_iwd_arcane_spells
  END
  ACTION_IF (include_IWD_divine_spells = 1) BEGIN
    LAM v75_add_iwd_divine_spells
  END
END
*/

ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
  LAM v75_apply_sr_aoe_deflection
END  

LAF fix_spell_bams END

COPY ~faiths_and_powers/data/hlas/system_vplus/~ ~weidu_external/faiths_and_powers/hlas~

//INCLUDE ~%mod_folder%/lib/immunities.tpa~					//	DO AT THE VERY END OF ALL SPELL INSTALLS

//create sphere system______________________________________________________________
//
INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~

INCLUDE ~override/fnp_sphere_list.tpa~
 LAM define_sphere_names
 LAM d5_define_sphere_spells
 LAM d5_deity_kit_sphere_lists

COPY ~d5/d5spsph.2da~ ~override~

COPY_EXISTING_REGEXP ~^[Ss][Pp][Pp][Rr][1-7][0-5a-zA-Z][0-9a-zA-Z]\.spl$~ ~override~
  PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
    PATCH_IF !(FILE_CONTAINS_EVALUATED (~hidespl.2da~ ~%SOURCE_RES%~)) OR !(~%SOURCE_RES%~ STRING_MATCHES_REGEXP ~[Ss][Pp][Pp][Rr][1-7]50~) BEGIN
	    READ_SHORT 0x1c ~spelltype~
	    PATCH_IF (~spelltype~ = 2) BEGIN
	      READ_BYTE 0x21 exclude
	      PATCH_IF ((exclude BAND 0b11000000) = 0b10000000) BEGIN // valid for clerics
	        SPRINT $cleric_only_spells(~%SOURCE_RES%~)~1~
	      END
	      PATCH_IF ((exclude BAND 0b11000000) = 0b01000000) BEGIN // valid for druids
	        SPRINT $druid_only_spells(~%SOURCE_RES%~)~1~
	      END
	      PATCH_IF ((exclude BAND 0b11000000) = 0b00000000) BEGIN // valid for both
	        SPRINT $cleric_druid_spells(~%SOURCE_RES%~)~1~
	      END
	      PATCH_IF ((exclude BAND 0b11000000) = 0b11000000) BEGIN // valid for neither
	        SPRINT $shaman_only_spells(~%SOURCE_RES%~)~1~
	      END
	    END
	END
  END
BUT_ONLY

ACTION_PHP_EACH cleric_only_spells AS res => ind BEGIN
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Cleric~
END
ACTION_PHP_EACH druid_only_spells AS res => ind BEGIN
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Druid~
END
ACTION_PHP_EACH cleric_druid_spells AS res => ind BEGIN
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Cleric~
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Druid~
END

LAF prep_vanilla_spells END

LAF create_spheres END

//all HLAs for everyone_____________________________________________________________
//
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/luclxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/ludrxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/lufcxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/lucrxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/luctxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/lucmxyz.2da~ ~override~
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @24 // vanilla plus - same as unmodded game, but kits gets focus access to two spheres
DESIGNATED 24
SUBCOMPONENT @20 
LABEL ~D5_VPLUS_SPHERE_SYSTEM~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__spheres.d5~
COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__v_plus_spheres.d5~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  MOVE ~override/fnp_sphere_list.tpa~ ~weidu_external/faiths_and_powers/fnp_sphere_list_old.tpa~
END

//prep sphere system________________________________________________________________
//
COPY ~faiths_and_powers/data/sphere_systems/sphere_list_vplus.tpa~ ~override/fnp_sphere_list.tpa~

//Add IWD and new spells____________________________________________________________
//
LAM d5_spell_options

ACTION_CLEAR_ARRAY aoe_spell

ACTION_IF (include_new_FNP_spells = 1) BEGIN
  INCLUDE ~faiths_and_powers/lib/spells_new_v75.tpa~      	//includes spells from the 0.75 series  
  INCLUDE ~faiths_and_powers/lib/spells_new_fnp.tpa~   		//new spells from the 0.77 series 
//  LAM v75_add_fnP_new_spells
  LAM v78_add_FnP_new_spells
END

/*
ACTION_IF !(GAME_IS ~iwdee~) BEGIN
  ACTION_IF (include_IWD_arcane_spells = 1) BEGIN
    LAM v75_add_iwd_arcane_spells
  END
  ACTION_IF (include_IWD_divine_spells = 1) BEGIN
    LAM v75_add_iwd_divine_spells
  END
END
*/

ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
  LAM v75_apply_sr_aoe_deflection
END  

LAF fix_spell_bams END

COPY ~faiths_and_powers/data/hlas/system_vplus/~ ~weidu_external/faiths_and_powers/hlas~

//INCLUDE ~%mod_folder%/lib/immunities.tpa~					//	DO AT THE VERY END OF ALL SPELL INSTALLS

//create sphere system______________________________________________________________
//
INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~

INCLUDE ~override/fnp_sphere_list.tpa~
 LAM define_sphere_names
 LAM d5_define_sphere_spells
 LAM d5_deity_kit_sphere_lists

COPY ~d5/d5spsph.2da~ ~override~

COPY_EXISTING_REGEXP ~^[Ss][Pp][Pp][Rr][1-7][0-5a-zA-Z][0-9a-zA-Z]\.spl$~ ~override~
  PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
    PATCH_IF !(FILE_CONTAINS_EVALUATED (~hidespl.2da~ ~%SOURCE_RES%~)) OR !(~%SOURCE_RES%~ STRING_MATCHES_REGEXP ~[Ss][Pp][Pp][Rr][1-7]50~) BEGIN
	    READ_SHORT 0x1c ~spelltype~
	    PATCH_IF (~spelltype~ = 2) BEGIN
	      READ_BYTE 0x21 exclude
	      PATCH_IF ((exclude BAND 0b11000000) = 0b10000000) BEGIN // valid for clerics
	        SPRINT $cleric_only_spells(~%SOURCE_RES%~)~1~
	      END
	      PATCH_IF ((exclude BAND 0b11000000) = 0b01000000) BEGIN // valid for druids
	        SPRINT $druid_only_spells(~%SOURCE_RES%~)~1~
	      END
	      PATCH_IF ((exclude BAND 0b11000000) = 0b00000000) BEGIN // valid for both
	        SPRINT $cleric_druid_spells(~%SOURCE_RES%~)~1~
	      END
	      PATCH_IF ((exclude BAND 0b11000000) = 0b11000000) BEGIN // valid for neither
	        SPRINT $shaman_only_spells(~%SOURCE_RES%~)~1~
	      END
	    END
	END
  END
BUT_ONLY

ACTION_PHP_EACH cleric_only_spells AS res => ind BEGIN
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Cleric~
END
ACTION_PHP_EACH druid_only_spells AS res => ind BEGIN
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Druid~
END
ACTION_PHP_EACH cleric_druid_spells AS res => ind BEGIN
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Cleric~
  APPEND ~d5spsph.2da~ ~%res%                 0	=	Druid~
END

LAF prep_vanilla_spells END

LAF create_spheres END

//all HLAs for everyone_____________________________________________________________
//
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/luclxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/ludrxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/lufcxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/lucrxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/luctxyz.2da~ ~override~
COPY_EXISTING ~faiths_and_powers/data/hlas/system_vplus/lucmxyz.2da~ ~override~
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @25 // new FnP sphere system - fewer spheres, more broadly balanced
DESIGNATED 25
SUBCOMPONENT @20 
LABEL ~D5_NU_FNP_SPHERE_SYSTEM~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__spheres.d5~
COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__nu_fnp_spheres.d5~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  MOVE ~override/fnp_sphere_list.tpa~ ~weidu_external/faiths_and_powers/fnp_sphere_list_old.tpa~
END

//prep sphere system________________________________________________________________
//
COPY ~faiths_and_powers/data/sphere_systems/sphere_list_new_fnp.tpa~ ~override/fnp_sphere_list.tpa~

//Add IWD and new spells____________________________________________________________
//
LAM d5_spell_options

ACTION_CLEAR_ARRAY aoe_spell

ACTION_IF (include_new_FNP_spells = 1) BEGIN
  INCLUDE ~faiths_and_powers/lib/spells_new_v75.tpa~      	//includes spells from the 0.75 series  
  INCLUDE ~faiths_and_powers/lib/spells_new_fnp.tpa~   		//new spells from the 0.77 series 
//  LAM v75_add_fnP_new_spells
  LAM v78_add_FnP_new_spells
END

ACTION_IF !(GAME_IS ~iwdee~) BEGIN
  ACTION_IF (include_IWD_arcane_spells = 1) BEGIN
    LAM v75_add_iwd_arcane_spells
  END
  ACTION_IF (include_IWD_divine_spells = 1) BEGIN
    LAM v75_add_iwd_divine_spells
  END
END

ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
  LAM v75_apply_sr_aoe_deflection
END  

LAF fix_spell_bams END

COPY ~faiths_and_powers/data/hlas/system_FnP_2/~ ~weidu_external/faiths_and_powers/hlas~

//INCLUDE ~%mod_folder%/lib/immunities.tpa~					//	DO AT THE VERY END OF ALL SPELL INSTALLS

INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~

 LAF prep_vanilla_spells END

INCLUDE ~override/fnp_sphere_list.tpa~
 LAM define_sphere_names
 LAM d5_define_sphere_spells
 LAM d5_deity_kit_sphere_lists

LAF create_spheres END
//__________________________________________________________________________________



/*
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @26 // 3E 'Domains'-style sphere system - start with a broad base of spells, then choose more
DESIGNATED 26
SUBCOMPONENT @20 
LABEL ~D5_DOMAINS_SPHERE_SYSTEM~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__spheres.d5~
COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__domain_spheres.d5~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  MOVE ~override/fnp_sphere_list.tpa~ ~weidu_external/faiths_and_powers/fnp_sphere_list_old.tpa~
END

//prep sphere system________________________________________________________________
//
COPY ~faiths_and_powers/data/sphere_systems/sphere_list_domains.tpa~ ~override/fnp_sphere_list.tpa~

//Add IWD and new spells____________________________________________________________
//
LAM d5_spell_options

ACTION_CLEAR_ARRAY aoe_spell

ACTION_IF (include_new_FNP_spells = 1) BEGIN
  INCLUDE ~faiths_and_powers/lib/spells_new_v75.tpa~      	//includes spells from the 0.75 series  
  INCLUDE ~faiths_and_powers/lib/spells_new_fnp.tpa~   		//new spells from the 0.77 series 
//  LAM v75_add_fnP_new_spells
  LAM v78_add_FnP_new_spells
END

ACTION_IF !(GAME_IS ~iwdee~) BEGIN
  ACTION_IF (include_IWD_arcane_spells = 1) BEGIN
    LAM v75_add_iwd_arcane_spells
  END
  ACTION_IF (include_IWD_divine_spells = 1) BEGIN
    LAM v75_add_iwd_divine_spells
  END
END

ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
  LAM v75_apply_sr_aoe_deflection
END  

LAF fix_spell_bams END

COPY ~faiths_and_powers/data/hlas/system_FnP_2/~ ~weidu_external/faiths_and_powers/hlas~

//INCLUDE ~%mod_folder%/lib/immunities.tpa~					//	DO AT THE VERY END OF ALL SPELL INSTALLS

INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~

 LAF prep_vanilla_spells END

INCLUDE ~override/fnp_sphere_list.tpa~
 LAM define_sphere_names
 LAM d5_define_sphere_spells
 LAM d5_deity_kit_sphere_lists

LAF create_spheres END
//__________________________________________________________________________________
*/




////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							SPONTANEOUS CASTING OPTION
//__________________________________________________________________________________
//__________________________________________________________________________________


BEGIN @30 // install spont option
DESIGNATED 30
LABEL ~D5_FNP_SPONTANEOUS_CASTING_OPTION~
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~d5__spheres.d5~) @8
REQUIRE_PREDICATE !(FILE_EXISTS_IN_GAME ~d5__5E_casting_clerics.d5~) @8


COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__fnp_spont_option.d5~
 

//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							INSTALL SINGLE-CLASS KITS
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @31 // install cleric kits
DESIGNATED 31
LABEL ~D5_FNP_CLERIC_KITS~

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
END
INCLUDE ~faiths_and_powers/lib/kits_new_clerics.tpa~

ACTION_IF !(FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__no_spheres.d5~
END

OUTER_SPRINT symbols_name @154
LAF rename_holy_symbols STR_VAR item_name = EVAL ~%symbols_name%~ END

LAM d5_kit_choices

ACTION_IF (GAME_IS ~iwdee~) && (cleric_kelemvor < 2) BEGIN
  OUTER_SET cleric_kelemvor = 0
END
ACTION_IF (GAME_IS ~iwdee~) && (cleric_cyric < 2) BEGIN
  OUTER_SET cleric_cyric = 0
END

ACTION_IF (ENGINE_IS ~tob bgt~) BEGIN
   OUTER_SET cleric_azuth	=	0
   OUTER_SET cleric_mystra	=	0
   OUTER_SET cleric_oghma	=	0
   OUTER_SET cleric_baervan 	=	0
   OUTER_SET cleric_arvoreen	=	0
   OUTER_SET d5_ur_priest	 	=	0
END

OUTER_SET cleric_umd = 0

// (clerics)
ACTION_IF (%cleric_moradin% = 1) BEGIN
  LAF cleric_moradin END
END
ACTION_IF (%cleric_clangeddin% = 1) BEGIN
  LAF cleric_clangeddin END
END
ACTION_IF (%cleric_marthammor% = 1) BEGIN
  LAF cleric_marthammor END
END
ACTION_IF (%cleric_baravar% = 1) BEGIN
  LAF cleric_baravar END
END
ACTION_IF (%cleric_baervan% = 1) BEGIN
  LAF cleric_baervan END
END
ACTION_IF (%cleric_urdlen% = 1) BEGIN
  OUTER_SET cleric_umd = 1
END
ACTION_IF (%cleric_yondalla% = 1) BEGIN
  LAF cleric_yondalla END
END
ACTION_IF (%cleric_arvoreen% = 1) BEGIN
  LAF cleric_arvoreen END
END
ACTION_IF (%scion_bhaal% = 1) BEGIN
  LAF scion_bhaal END
END
ACTION_IF (%cleric_azuth% = 1) BEGIN
  OUTER_SET cleric_umd = 1
  LAF cleric_azuth END
END
ACTION_IF (%cleric_beshaba% = 1) BEGIN
  LAF cleric_beshaba END
END
ACTION_IF (%cleric_cyric% = 1) BEGIN
  LAF cleric_cyric END
END
ACTION_IF (%cleric_deneir% = 1) BEGIN
  OUTER_SET cleric_umd = 1
  LAF cleric_deneir END
END
ACTION_IF (%cleric_helm% = 1) BEGIN
  LAF cleric_helm END
END
ACTION_IF (%cleric_ilmater% = 1) BEGIN
  LAF cleric_ilmater END
END
ACTION_IF (%cleric_kelemvor% = 1) BEGIN
  LAF cleric_kelemvor END
END
ACTION_IF (%cleric_lathander% = 1) BEGIN
  LAF cleric_lathander END
END
ACTION_IF (%cleric_leira% = 1) BEGIN
  LAF cleric_leira END
END
ACTION_IF (%cleric_loviatar% = 1) BEGIN
  LAF cleric_loviatar END
END
ACTION_IF (%cleric_malar% = 1) BEGIN
  LAF cleric_malar END
END
ACTION_IF (%cleric_moander% = 1) BEGIN
  LAF cleric_moander END
END
ACTION_IF (%cleric_mystra% = 1) BEGIN
  OUTER_SET cleric_umd = 1
  LAF cleric_mystra END
END
ACTION_IF (%cleric_oghma% = 1) BEGIN
  OUTER_SET cleric_umd = 1
  LAF cleric_oghma END
END
ACTION_IF (%cleric_shar% = 1) BEGIN
  LAF cleric_shar END
END
ACTION_IF (%cleric_sune% = 1) BEGIN
  LAF cleric_sune END
END
ACTION_IF (%cleric_talos% = 1) BEGIN
  LAF cleric_talos END
END
ACTION_IF (%cleric_tempus% = 1) BEGIN
  LAF cleric_tempus END
END
ACTION_IF (%priest_tempus% = 1) BEGIN
  LAF priest_tempus END
END
ACTION_IF (%cleric_torm% = 1) BEGIN
  LAF cleric_torm END
END
ACTION_IF (%cleric_tymora% = 1) BEGIN
  LAF cleric_tymora END
END
ACTION_IF (%cleric_umberlee% = 1) BEGIN
  LAF cleric_umberlee END
END
//

// (ur-priest)
ACTION_IF (%ur_priest% = 1) BEGIN
  LAF cleric_ur_priest END
END

LAF remove_sc_menu_kits STR_VAR class = ~C~ END

ACTION_IF	(ENGINE_IS ~tob bgt~) &&
			(MOD_IS_INSTALLED ~DIVINE_REMIX/SETUP-DIVINE_REMIX.TP2~ ~1000~) &&
			(FILE_EXISTS ~divine_remix/lib/macros.tph~) BEGIN
  INCLUDE ~faiths_and_powers/lib/kits_dr_compatibility.tpa~
  LAF cleric_dr_spheres END
END

ACTION_IF (cleric_umd = 1) BEGIN
  INCLUDE ~%MOD_FOLDER%/lib/d5_umd.tpa~
  LAF use_magical_devices END
END

//Psionic Wild Talents______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5pswt_.spl~) BEGIN
 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 2 ; row < rows ; ++row) BEGIN
	READ_2DA_ENTRY %row% 5 10 modclab
	READ_2DA_ENTRY %row% 8 10 modclass
	PATCH_IF modclass = 3 BEGIN
	  PATCH_IF (FILE_EXISTS_IN_GAME ~%modclab%.2da~) BEGIN
		INNER_ACTION BEGIN
		  APPEND ~%modclab%.2da~ ~WILD_TLNT   AP_D5PSWT_  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5PSWT_~
		END
	  END
	END
  END
 BUT_ONLY
END
//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
BEGIN @33 // install druid kits
DESIGNATED 33
LABEL ~D5_FNP_DRUID_KITS~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
END
INCLUDE ~faiths_and_powers/lib/kits_new_druids.tpa~
INCLUDE ~faiths_and_powers/lib/semi_innate.tpa~

ACTION_IF !(FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__no_spheres.d5~
END

//change druid class text____________________________________________________________
//
LAF druid_class_text END
//__________________________________________________________________________________

/*
//druids on cleric spell/xp tables__________________________________________________
//
LAM d5_druid_xp_table
ACTION_IF (druids_use_cleric_XP = 1) BEGIN
  LAF druid_xp END
END
//__________________________________________________________________________________
*/

LAM d5_kit_choices

ACTION_IF (FILE_EXISTS_IN_GAME ~d5__no_spheres.d5~) BEGIN
   OUTER_SET earth_mystic 		=	0
   OUTER_SET water_mystic 		=	0
   OUTER_SET air_mystic 		=	0
   OUTER_SET fire_mystic 		=	0
   OUTER_SET light_mystic 		=	0
   OUTER_SET shadow_mystic 		=	0
   OUTER_SET elementalist 		=	0
   OUTER_SET hivekeeper_druid 	=	0
END

// (druids)
ACTION_IF (%forest_druid% = 1) BEGIN
  LAF forest_druid END
END
ACTION_IF (%totemic_druid% = 1) BEGIN
  LAF totemic_druid END
END
ACTION_IF (%hivekeeper_druid% = 1) BEGIN
  LAF hivekeeper_druid END
END
ACTION_IF (%northern_druid% = 1) BEGIN
  LAF northern_druid END
END
ACTION_IF (%lost_druid% = 1) BEGIN
  LAF lost_druid END
END
ACTION_IF (%beast_lord% = 1) BEGIN
  LAF beast_lord END
END
//ACTION_IF (%forest_druid% + %totemic_druid% + %hivekeeper_druid% + %northern_druid% + %lost_druid% > 0) BEGIN
  LAF druid_shapeshifting END
//END
ACTION_IF (%elementalist% = 1) BEGIN
  LAF elementalist END
END
ACTION_IF (%earth_mystic% = 1) BEGIN
  LAF earth_mystic END
END
ACTION_IF (%water_mystic% = 1) BEGIN
  LAF water_mystic END
END
ACTION_IF (%air_mystic% = 1) BEGIN
  LAF air_mystic END
END
ACTION_IF (%fire_mystic% = 1) BEGIN
  LAF fire_mystic END
END
ACTION_IF (%light_mystic% = 1) BEGIN
  LAF light_mystic END
END
ACTION_IF (%shadow_mystic% = 1) BEGIN
  LAF shadow_mystic END
END

LAF remove_sc_menu_kits STR_VAR class = ~D~ END

LAF clear_druid_clab END

//Psionic Wild Talents______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5pswt_.spl~) BEGIN
 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 2 ; row < rows ; ++row) BEGIN
	READ_2DA_ENTRY %row% 5 10 modclab
	READ_2DA_ENTRY %row% 8 10 modclass
	PATCH_IF modclass = 11 || modclass = 21 BEGIN
	  PATCH_IF (FILE_EXISTS_IN_GAME ~%modclab%.2da~) BEGIN
		INNER_ACTION BEGIN
		  APPEND ~%modclab%.2da~ ~WILD_TLNT   AP_D5PSWT_  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5PSWT_~
		END
	  END
	END
  END
 BUT_ONLY
END
//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
BEGIN @35 // install paladin kits
DESIGNATED 35
SUBCOMPONENT @40
LABEL ~D5_FNP_PALADIN_KITS~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
END
INCLUDE ~faiths_and_powers/lib/kits_new_paladins.tpa~
INCLUDE ~faiths_and_powers/lib/dialprof.tpa~

ACTION_IF !(FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__no_spheres.d5~
END

//remove vanilla kits_______________________________________________________________
//
LAF remove_sc_menu_kits STR_VAR class = ~P~ END

//set up archetypes_________________________________________________________________
//
LAM set_paladin_archetype_choices

LAF paladin_archetypes END

//__________________________________________________________________________________
//
LAM d5_kit_choices

LAF enable_more_paladins END

ACTION_IF (%champion_tyr% = 1) BEGIN
  LAF champion_tyr END
END
ACTION_IF (%champion_torm% = 1) BEGIN
  LAF champion_torm END
END
ACTION_IF (%champion_helm% = 1) BEGIN
  LAF champion_helm END
END
ACTION_IF (%champion_ilmater% = 1) BEGIN
 LAF champion_ilmater END
END
ACTION_IF (%champion_kelemvor% = 1) BEGIN
 //kelevmor undead hunter for non-iwdee
 ACTION_IF !(GAME_IS ~iwdee~) THEN BEGIN  
  LAF champion_kelemvor END
 END
END
ACTION_IF (%champion_sune% = 1) BEGIN
 LAF champion_sune END
END

//Psionic Wild Talents______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5pswt_.spl~) BEGIN
 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 2 ; row < rows ; ++row) BEGIN
	READ_2DA_ENTRY %row% 5 10 modclab
	READ_2DA_ENTRY %row% 8 10 modclass
	PATCH_IF modclass = 6 BEGIN
	  PATCH_IF (FILE_EXISTS_IN_GAME ~%modclab%.2da~) BEGIN
		INNER_ACTION BEGIN
		  APPEND ~%modclab%.2da~ ~WILD_TLNT   AP_D5PSWT_  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5PSWT_~
		END
	  END
	END
  END
 BUT_ONLY
END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
BEGIN @36 // install all paladin kits
DESIGNATED 36
SUBCOMPONENT @40
LABEL ~D5_FNP_BAD_PALADINS~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
END
INCLUDE ~faiths_and_powers/lib/kits_new_paladins.tpa~
INCLUDE ~faiths_and_powers/lib/dialprof.tpa~

ACTION_IF !(FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__no_spheres.d5~
END

//remove vanilla kits_______________________________________________________________
//
LAF remove_sc_menu_kits STR_VAR class = ~P~ END

//set up archetypes_________________________________________________________________
//
LAM set_paladin_archetype_choices

LAF paladin_archetypes END

//__________________________________________________________________________________
//
LAM d5_kit_choices

LAF enable_more_paladins END

ACTION_IF (%champion_moradin% = 1) BEGIN
  LAF champion_moradin END
END
ACTION_IF (%champion_arvoreen% = 1) BEGIN
  LAF champion_arvoreen END
END
ACTION_IF (%champion_corellon% = 1) BEGIN
 LAF champion_corellon END
END
ACTION_IF (%champion_eilistraee% = 1) BEGIN
 LAF champion_eilistraee END
END
ACTION_IF (%champion_gruumsh% = 1) BEGIN
  LAF champion_gruumsh END
END
ACTION_IF (%champion_tyr% = 1) BEGIN
  LAF champion_tyr END
END
ACTION_IF (%champion_torm% = 1) BEGIN
  LAF champion_torm END
END
ACTION_IF (%champion_helm% = 1) BEGIN
  LAF champion_helm END
END
ACTION_IF (%champion_ilmater% = 1) BEGIN
 LAF champion_ilmater END
END
ACTION_IF (%champion_tempus% = 1) BEGIN
  LAF champion_tempus END
END
ACTION_IF (%champion_kelemvor% = 1) BEGIN
 //champ of Kele effectively replaces UHunter. In IWDEE, the champ of mykrul is merely added (they're different enough conceptually to be seperate)
 ACTION_IF GAME_IS ~iwdee~ THEN BEGIN  
  LAF iwdee_champion_myrkul_archetypes END
  LAF iwdee_champion_kelemvor END
 END
 //kelevmor undead hunter for non-iwdee
 ACTION_IF GAME_IS ~bgee bg2ee eet~ THEN BEGIN 
  LAF champion_kelemvor END
 END
END
ACTION_IF (%champion_sune% = 1) BEGIN
 LAF champion_sune END
END
ACTION_IF (%champion_mystra% = 1) BEGIN
 LAF champion_mystra END
END
ACTION_IF (%champion_azuth% = 1) BEGIN
  LAF champion_azuth	 END
END
ACTION_IF (%champion_red% = 1) BEGIN
  LAF champion_red END
END
ACTION_IF (%champion_talos% = 1) BEGIN
  LAF champion_talos END
END
ACTION_IF (%champion_kossuth% = 1) BEGIN
  LAF champion_kossuth END
END
ACTION_IF (%champion_garagos% = 1) BEGIN
  LAF champion_garagos END
END
ACTION_IF (%champion_bane% = 1) BEGIN
 ACTION_IF GAME_IS ~iwdee~ THEN BEGIN  
  LAF champion_bane END
 END
END

//Psionic Wild Talents______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5pswt_.spl~) BEGIN
 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 2 ; row < rows ; ++row) BEGIN
	READ_2DA_ENTRY %row% 5 10 modclab
	READ_2DA_ENTRY %row% 8 10 modclass
	PATCH_IF modclass = 6 BEGIN
	  PATCH_IF (FILE_EXISTS_IN_GAME ~%modclab%.2da~) BEGIN
		INNER_ACTION BEGIN
		  APPEND ~%modclab%.2da~ ~WILD_TLNT   AP_D5PSWT_  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5PSWT_~
		END
	  END
	END
  END
 BUT_ONLY
END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
BEGIN @45 // revised paladin spell table
DESIGNATED 45
LABEL ~D5_PALADIN_SPELL_TABLE~

LAF paladin_spell_tables END
//__________________________________________________________________________________




////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


/*
//__________________________________________________________________________________
//__________________________________________________________________________________
//
//					              ADD SPELL SCROLLS FOR PRIESTS
//__________________________________________________________________________________
//__________________________________________________________________________________

//testing

BEGIN @70 // Add spell scrolls for priests
DESIGNATED 70
//LABEL ~B_PRIEST_SPELL_SCROLLS~

//marker
COPY_EXISTING ~SW1H04.itm~ ~override/B_fnp070.itm~

INCLUDE ~faiths_and_powers/data/components/Setup_Priest_Scrolls.tpa~

//test on vanilla (no reason I can think of it wouldn't work)
//__________________________________________________________________________________
*/


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//					CHOOSE WHETHER TO CHANGE USABILITY/PROFICIENCY
//__________________________________________________________________________________
//__________________________________________________________________________________


// ***** set this up to work with new .ini option!

// ***** and see if it even matters for paladins. if not, remove it from their .tpa file

BEGIN @75 // item usability
DESIGNATED 75
LABEL ~D5_FNP_WEAPON_USABILITY~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

COPY ~faiths_and_powers/lib/markers/d5_marker.d5~ ~override/d5__fnp_usability.d5~

INCLUDE ~faiths_and_powers/lib/qd_multiclass.tpa~

//read in kit functions_____________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
//  INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~
  LAM define_sphere_names
  LAM d5_define_sphere_spells
  LAM d5_deity_kit_sphere_lists
END

INCLUDE ~faiths_and_powers/lib/kits_default_handling.tpa~
 LAF vanilla_kit_spheres END
 LAF mod_kit_spheres END
 LAF default_kit_spheres END
//__________________________________________________________________________________

//read system_base info in order to apply sphere system/item usability_______________
//
LAM ~READ_FNP_KIT_INFO~
//__________________________________________________________________________________

//alter item usability______________________________________________________________
//
// LAM d5_fnp_weapon_usability	//	not implemented yet
OUTER_SET simpler_usability_changes	=	0	//	do this for now instead

INCLUDE ~faiths_and_powers/lib/system_item_use.tpa~
 LAF change_usability END
 LAF apply_usability END
//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//								APPLY SPHERE SYSTEM
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @80 // apply sphere systen
DESIGNATED 80
LABEL ~D5_APPLY_SPHERE_SYSTEM~
//INSTALL_BY_DEFAULT
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8
REQUIRE_PREDICATE (FILE_EXISTS_IN_GAME ~d5__spheres.d5~) @8
FORBID_COMPONENT ~faiths_and_powers.tp2~ ~29~ @8


//check sphere system_______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~clabpr01.2da~) && (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
// INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~
 INCLUDE ~override/fnp_sphere_list.tpa~
  LAM define_sphere_names
  LAM d5_define_sphere_spells
  LAM d5_deity_kit_sphere_lists
END
//__________________________________________________________________________________

//read in kit functions_____________________________________________________________
//
INCLUDE ~faiths_and_powers/lib/kits_default_handling.tpa~
 LAF vanilla_kit_spheres END
 LAF mod_kit_spheres END
 LAF default_kit_spheres END
//__________________________________________________________________________________

//read system_base info in order to apply sphere system/item usability______________
//
 LAM ~READ_FNP_KIT_INFO~
//__________________________________________________________________________________

//Apply Sphere System_______________________________________________________________
//
 LAF apply_spheres END
//__________________________________________________________________________________

//universal spells available at CharGen_____________________________________________
//
//ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__v_plus_spheres.d5~) BEGIN
 LAF universal_spells END
//END
//__________________________________________________________________________________

//reapply 5E casting for divine spells______________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__5E_casting_divine.d5~) BEGIN
  INCLUDE ~faiths_and_powers/lib/semi_spontaneous.tpa~
  LAF semi_divine_spells END
  LAF process_semi_spells END
END
//__________________________________________________________________________________

//__________________________________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5__spont_items_mem.d5~) BEGIN
    INCLUDE ~%MOD_FOLDER%/lib/semi_spontaneous.tpa~
    LAF divine_spont_items INT_VAR 5e_plus_mem = 1 END
  END
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5__spont_items_no_mem.d5~) BEGIN
    INCLUDE ~%MOD_FOLDER%/lib/semi_spontaneous.tpa~
    LAF divine_spont_items INT_VAR 5e_plus_mem = 0 END
  END
END
//__________________________________________________________________________________

//Trueclass Spheres_________________________________________________________________
//
 ACTION_IF (FILE_EXISTS_IN_GAME ~d5fpclsp.spl~) BEGIN
  APPEND ~clabpr01.2da~ ~CLER_SPLS   AP_D5FPCLSP ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPCLSP~
 END
 ACTION_IF (FILE_EXISTS_IN_GAME ~d5fpdrsp.spl~) BEGIN
  APPEND ~clabdr01.2da~ ~DRU_SPLS    AP_D5FPDRSP ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPDRSP~
 END
 ACTION_IF (FILE_EXISTS_IN_GAME ~d5fprnsp.spl~) BEGIN
  APPEND ~clabrn01.2da~ ~RAN_SPLS    AP_D5FPRNSP ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPRNSP~
 END
//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//  do this up with the regular druids...?
//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							INSTALL MULTICLASS DRUIDS
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @91 // install multiclass druids
DESIGNATED 91
LABEL ~D5_FNP_MULTI_DRUID_KITS~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

ACTION_IF !(FILE_EXISTS ~TobEx_ini/TobExVer.txt~) BEGIN
  COPY ~%MOD_FOLDER%/data/TobExVer.txt~ ~TobEx_ini/TobExVer.txt~
END

INCLUDE ~faiths_and_powers/lib/system_compat.tpa~
//INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~
ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
  LAM define_sphere_names
  LAM d5_define_sphere_spells
  LAM d5_deity_kit_sphere_lists
END

LAF multiclass_text END

LAF enable_multiclasses END

LAM d5_kit_choices

// LAM d5_fnp_weapon_usability	//	not implemented yet
OUTER_SET simpler_usability_changes	=	0	//	do this for now instead

INCLUDE ~faiths_and_powers/lib/kits_multi_druids_shamans.tpa~

  LAF fighter_druid END
  LAF druid_ranger END
  LAF druid_thief END
  LAF druid_mage END
  ACTION_IF (MOD_IS_INSTALLED ~tomeandblood.tp2~ ~80~) BEGIN
	LAF sorcerer_druid END
  END
  ACTION_IF (FILE_EXISTS_IN_GAME ~qd_monk_multi.qd~) BEGIN
	LAF druid_monk END
  END  
  LAF multi_druid_strongholds END
/*
  ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
    LAF no_spheres_druid_spells END
  END
*/
  ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
    LAF no_spheres_druid_usability END
  END

LAF remove_mc_menu_kits END

ACTION_IF FILE_EXISTS ~TobEx_ini/TobExVer.txt~ BEGIN
	DELETE ~TobEx_ini/TobExVer.txt~
END
//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							INSTALL MULTICLASS SHAMANS
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @92 // install multiclass shamans
DESIGNATED 92
LABEL ~D5_FNP_MULTI_SHAMAN_KITS~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

ACTION_IF !(FILE_EXISTS ~TobEx_ini/TobExVer.txt~) BEGIN
  COPY ~%MOD_FOLDER%/data/TobExVer.txt~ ~TobEx_ini/TobExVer.txt~
END

INCLUDE ~faiths_and_powers/lib/system_compat.tpa~
//INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~
ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
  LAM define_sphere_names
  LAM d5_define_sphere_spells
  LAM d5_deity_kit_sphere_lists
END

LAF multiclass_text END

LAF enable_multiclasses END

LAM d5_kit_choices

// LAM d5_fnp_weapon_usability	//	not implemented yet
OUTER_SET simpler_usability_changes	=	0	//	do this for now instead

INCLUDE ~faiths_and_powers/lib/kits_multi_druids_shamans.tpa~

//ACTION_IF (%multiclass_shamans% = 1) BEGIN
  LAF sham_barb END
  LAF ranger_shaman END
  LAF shaman_thief END
  LAF shaman_mage END
  ACTION_IF (FILE_EXISTS_IN_GAME ~qd_monk_multi.qd~) BEGIN
	LAF shaman_monk END
  END  
  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN
	LAF multiclass_shaman_system END
  END
  LAF multi_shaman_strongholds END
  ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
   ACTION_IF !(FILE_EXISTS_IN_GAME ~d5drth.2da~) BEGIN
    LAF no_spheres_druid_usability END
   END
  END
//END

LAF remove_mc_menu_kits END

ACTION_IF FILE_EXISTS ~TobEx_ini/TobExVer.txt~ BEGIN
	DELETE ~TobEx_ini/TobExVer.txt~
END
//__________________________________________________________________________________



////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							INSTALL MULTICLASS KITS
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @95 // install multiclass kits
DESIGNATED 95
LABEL ~D5_FNP_MULTI_CLERIC_KITS~
REQUIRE_PREDICATE (GAME_IS ~bgee bg2ee eet iwdee~) @8

ACTION_IF !(FILE_EXISTS ~TobEx_ini/TobExVer.txt~) BEGIN
  COPY ~%MOD_FOLDER%/data/TobExVer.txt~ ~TobEx_ini/TobExVer.txt~
END

INCLUDE ~faiths_and_powers/lib/system_compat.tpa~
//INCLUDE ~faiths_and_powers/lib/system_spheres.tpa~
ACTION_IF (FILE_EXISTS_IN_GAME ~fnp_sphere_list.tpa~) BEGIN
  INCLUDE ~override/fnp_sphere_list.tpa~
   LAM define_sphere_names
   LAM d5_define_sphere_spells
   LAM d5_deity_kit_sphere_lists
END

INCLUDE ~faiths_and_powers/lib/kits_default_handling.tpa~
 LAF vanilla_kit_spheres END
 LAF mod_kit_spheres END
 LAF default_kit_spheres END

LAF multiclass_text END

LAF enable_multiclasses END

LAM d5_kit_choices

// LAM d5_fnp_weapon_usability	//	not implemented yet
OUTER_SET simpler_usability_changes	=	0	//	do this for now instead

INCLUDE ~faiths_and_powers/lib/kits_new_multiclass.tpa~

ACTION_IF (%cm_mystra% = 1) BEGIN
  LAF cm_mystra END
END
ACTION_IF (%cm_azuth% = 1) BEGIN
  LAF cm_azuth END
END
ACTION_IF (%cr_mielikki% = 1) BEGIN
  LAF cr_mielikki END
END
ACTION_IF (%cr_shaundakul% = 1) BEGIN
  LAF cr_shaundakul END
END
ACTION_IF (%ct_mask% = 1) BEGIN
  LAF ct_mask END
END
ACTION_IF (%ct_brandobaris% = 1) BEGIN
  LAF ct_brandobaris END
END

ACTION_IF (%multiclass_clerics% = 1) BEGIN
  LAF multiclass_kit_clones END
END

ACTION_IF (FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN
  LAF remove_mc_menu_kits END
END

ACTION_IF FILE_EXISTS ~TobEx_ini/TobExVer.txt~ BEGIN
	DELETE ~TobEx_ini/TobExVer.txt~
END
//__________________________________________________________________________________


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//  do this automatically as kits are installed...?
//__________________________________________________________________________________
//__________________________________________________________________________________
//
//						CHOOSE WHETHER TO CHANGE NPC KITS
//__________________________________________________________________________________
//__________________________________________________________________________________

BEGIN @99 // apply kits to multiclass NPCS
DESIGNATED 99
LABEL ~D5_FNP_KITS_TO_NPCS~
//INSTALL_BY_DEFAULT
REQUIRE_PREDICATE (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~31~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~33~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~35~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~91~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~95~) @8


//read in kit functions_____________________________________________________________
//
INCLUDE ~faiths_and_powers/lib/system_npc_kits.tpa~

ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~31~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~33~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~35~) BEGIN
  LAF npc_sc_kits END
END

ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~91~) OR (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~95~) BEGIN
  LAF npc_mc_kits END
END
//__________________________________________________________________________________
