
//__________________________________________________________________________________
//__________________________________________________________________________________
//
DEFINE_ACTION_FUNCTION no_spheres_druid_spells STR_VAR clab_table = ~x~ BEGIN

 COPY_EXISTING_REGEXP GLOB ~^SPPR[1-7]\(0[1-9]\|[1-4][0-9]\|50\)\.spl$~ ~override~
  READ_SHORT 0x1c spell_type
  READ_BYTE 0x21 divine
  PATCH_IF (spell_type = 2) && ((%divine% BOR 0b01111111) = 0b01111111) && !(FILE_CONTAINS_EVALUATED (~hidespl.2da~ ~%SOURCE_RES%~)) BEGIN	//	druid-valid spells
	SPRINT $druid_valid_spells(~%SOURCE_RES%~) ~druid~
  END
  PATCH_IF (spell_type = 2) && ((%divine% BAND 0b10000000) = 0b10000000) && !(FILE_CONTAINS_EVALUATED (~hidespl.2da~ ~%SOURCE_RES%~)) BEGIN	//	druid-invalid spells
	SPRINT $cleric_only_spells(~%SOURCE_RES%~) ~cleric~
  END
 BUT_ONLY
 
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5druys.spl~
  PHP_EACH druid_valid_spells AS dru_res => type BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = EVAL ~%dru_res%~ END
  END

 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5druno.spl~
  PHP_EACH cleric_only_spells AS cle_res => type BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 4 duration = 1 STR_VAR resource = EVAL ~%cle_res%~ END
  END

 COPY ~faiths_and_powers/data/misc/d5spmem.spl~ ~override~
	SAY NAME1 @1100
	SAY UNIDENTIFIED_DESC @1101
	WRITE_ASCII 0x3a ~d5spm3mb~ #8
	LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5spm3mb~ END
 COPY ~faiths_and_powers/data/misc/d5spm3m.spl~ ~override~
	SAY NAME1 @1100
	SAY UNIDENTIFIED_DESC @1101
	WRITE_ASCII 0x3a ~d5spm3mb~ #8
	LPF ALTER_SPELL_HEADER STR_VAR icon = ~d5spm3mb~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5spm3m~ END
 COPY ~faiths_and_powers/data/misc/d5spm3mb.bam~ ~override~

  ACTION_IF (FILE_EXISTS_IN_GAME ~%clab_table%.2da~) BEGIN
	APPEND ~%clab_table%.2da~ ~NO_SPELLS   AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO  AP_D5DRUNO 
FREESPLS    AP_D5DRUYS  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
FAKE_REST   AP_D5SPMEM  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
  END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
DEFINE_ACTION_FUNCTION no_spheres_druid_usability BEGIN

/*
// do a miniature version of the fnp usability function

// not using kit flags then, so assign multicleric combos to druids to one, and other clerics to another

// make all cleric & druid weapons usable by clerics, then bar each category from one flag, bob's your uncle

- talos flag 		= c/t		= 0x01000000
- helm flag 		= c/w		= 0x02000000
- lathander flag 	= c/m		= 0x04000000
- totemic flag		= druid		= 0x08000000h

./ if usable by druids, make usable by all multi cleric classes

*/

 OUTER_TEXT_SPRINT hex_talos 		~01000000~	//	c/t, c/m
 OUTER_TEXT_SPRINT hex_helm 		~02000000~	//	f/c, c/r
 OUTER_TEXT_SPRINT hex_lathander	~04000000~	//	dru
 OUTER_TEXT_SPRINT hex_totemic 		~08000000~	//	

 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (~%SOURCE_SIZE%~ > ~0x71~) BEGIN
	READ_BYTE    0x1f class_2			// cleric multiclass flags
	READ_BYTE    0x21 class_4			// druid class flag
	READ_BYTE    0x29 kits				// cleric kit flags
	PATCH_IF ((%class_2% BAND 0b01000000) = 0b01000000) BEGIN 		// if *NOT usable* by F/C
	  WRITE_BYTE 0x29 (%kits% BOR 0b00000010) 						// not usable by helm
	  READ_BYTE  0x29 kits
	END
	PATCH_IF ((%class_2% BAND 0b00000100) = 0b00000100) BEGIN 		// if *NOT usable* by R/C
	  WRITE_BYTE 0x29 (%kits% BOR 0b00000010) 						// not usable by helm
	  READ_BYTE  0x29 kits
	END
	PATCH_IF ((%class_2% BAND 0b00000010) = 0b00000010) BEGIN 		// if *NOT usable* by C/T
	  WRITE_BYTE 0x29 (%kits% BOR 0b00000001) 						// not usable by talos
	  READ_BYTE  0x29 kits
	END
	PATCH_IF ((%class_2% BAND 0b00000001) = 0b00000001) BEGIN 		// if *NOT usable* by C/M
	  WRITE_BYTE 0x29 (%kits% BOR 0b00000001) 						// not usable by talos
	  READ_BYTE  0x29 kits
	END
	PATCH_IF ((%class_4% BOR 0b10111111) = 0b10111111) BEGIN		// if *IS usable* by druids
	  WRITE_BYTE 0x1f (%class_2% BAND 0b10111000)					// make usable by multi clerics
	  READ_BYTE  0x1f class_2
	  WRITE_BYTE 0x29 (%kits% BAND 0b11110111) 						// make usable by totemic
	  READ_BYTE  0x29 kits
	END
	PATCH_IF ((%class_4% BAND 0b01000000) = 0b01000000) BEGIN		// if *NOT* usable by druids
	  WRITE_BYTE 0x29 (%kits% BOR 0b00001000) 						// not usable by totemic
	  READ_BYTE  0x29 kits
	END
  END
 BUT_ONLY

/*
 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (~%SOURCE_SIZE%~ > ~0x71~) BEGIN
	READ_BYTE    0x1f class_2			// cleric multiclass flags
	READ_BYTE    0x21 class_4			// druid class flag
	READ_BYTE    0x29 kits				// cleric kit flags
	PATCH_IF (%class_4% BOR 0b10111111 = 0b10111111) BEGIN			// if *IS usable* by druids
	  WRITE_BYTE 0x1f (%class_2% BAND 0b10111000)					// make usable by multi clerics
	  READ_BYTE  0x1f class_2
	  WRITE_BYTE 0x29 (%kits% BAND 0b11111011) 						// make usable by lathander
//	  WRITE_BYTE 0x29 (%kits% BAND 0b11110111) 						// make usable by totemic
// can only do ONE write_byte!!!
	  READ_BYTE  0x29 kits
	END
  END
 BUT_ONLY

 COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
  PATCH_IF (~%SOURCE_SIZE%~ > ~0x71~) BEGIN
	READ_BYTE    0x21 class_4			// druid class flag
	READ_BYTE    0x29 kits				// cleric kit flags
	PATCH_IF (%class_4% BAND 0b01000000 = 0b01000000) BEGIN			// if *NOT* usable by druids
	  WRITE_BYTE 0x29 (%kits% BOR 0b00000100) 						// not usable by lathander
//	  WRITE_BYTE 0x29 (%kits% BOR 0b00001000) 						// not usable by totemic
	END
  END
 BUT_ONLY
*/

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 8 10 class_num
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (IS_AN_INT %class_num%) && (class_num = 8) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5drfi~) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5shmbb~) BEGIN
	  SET_2DA_ENTRY row 7 10 ~0x%hex_helm%~
	END
	PATCH_IF (IS_AN_INT %class_num%) && (class_num = 18) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5drra~) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5shmrn~) BEGIN
	  SET_2DA_ENTRY row 7 10 ~0x%hex_helm%~
	END
	PATCH_IF (IS_AN_INT %class_num%) && (class_num = 15) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5drth~) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5shmth~) BEGIN
	  SET_2DA_ENTRY row 7 10 ~0x%hex_talos%~
	END
	PATCH_IF (IS_AN_INT %class_num%) && (class_num = 14) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5drma~) && !(~%clab_name%~ STRING_EQUAL_CASE ~d5shmma~) BEGIN
	  SET_2DA_ENTRY row 7 10 ~0x%hex_talos%~
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5drfi.2da~) BEGIN
  OUTER_SET fighter_druid_code = IDS_OF_SYMBOL (~kit~ ~D5_DR_FIGHTER~)
  OUTER_SET ranger_druid_code = IDS_OF_SYMBOL (~kit~ ~D5_DR_RANGER~)
  OUTER_SET druid_thief_code = IDS_OF_SYMBOL (~kit~ ~D5_DR_THIEF~)
  OUTER_SET druid_mage_code = IDS_OF_SYMBOL (~kit~ ~D5_DR_MAGE~)
  COPY_EXISTING_REGEXP GLOB ~^.+\.itm$~ ~override~
	PATCH_IF (~%SOURCE_SIZE%~ > ~0x71~) BEGIN
	  LPF CLONE_EFFECT INT_VAR silent = 1 multi_match = 1 match_opcode = 319 match_parameter1 = 11 match_parameter2 = 5 parameter1 = %fighter_druid_code% parameter2 = 9 END
	  LPF CLONE_EFFECT INT_VAR silent = 1 multi_match = 1 match_opcode = 319 match_parameter1 = 11 match_parameter2 = 5 parameter1 = %ranger_druid_code% parameter2 = 9 END
	  LPF CLONE_EFFECT INT_VAR silent = 1 multi_match = 1 match_opcode = 319 match_parameter1 = 11 match_parameter2 = 5 parameter1 = %druid_thief_code% parameter2 = 9 END
	  LPF CLONE_EFFECT INT_VAR silent = 1 multi_match = 1 match_opcode = 319 match_parameter1 = 11 match_parameter2 = 5 parameter1 = %druid_mage_code% parameter2 = 9 END
	END
  BUT_ONLY
/*
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 0; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 5 10 clab_name
	  PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfi~) || (~%clab_name%~ STRING_EQUAL_CASE ~d5drra~) || (~%clab_name%~ STRING_EQUAL_CASE ~d5drth~) || (~%clab_name%~ STRING_EQUAL_CASE ~d5drma~) BEGIN
		SET_2DA_ENTRY row 7 10 ~0x%hex_lathander%~
	  END
	END
  BUT_ONLY
*/
 END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
DEFINE_ACTION_FUNCTION multi_druid_shapeshifting BEGIN

// get kit codes
//
COPY_EXISTING ~kit.ids~ ~override~
  COUNT_2DA_COLS cols 
  READ_2DA_ENTRIES_NOW rows cols 
  FOR (row = 1; row < rows; ++row) BEGIN 
    READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
    PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FIGHTER~ BEGIN
      SET fighter_row = %row%
      READ_2DA_ENTRY_FORMER rows fighter_row 0 fighter_druid_code
    END
    PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MAGE~ BEGIN
      SET mage_row = %row%
      READ_2DA_ENTRY_FORMER rows mage_row 0 mage_druid_code
    END
    PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_RANGER~ BEGIN
      SET ranger_row = %row%
      READ_2DA_ENTRY_FORMER rows ranger_row 0 ranger_druid_code
    END
    PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_THIEF~ BEGIN
      SET thief_row = %row%
      READ_2DA_ENTRY_FORMER rows thief_row 0 thief_druid_code
    END
    PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MONK~ BEGIN
      SET thief_row = %row%
      READ_2DA_ENTRY_FORMER rows thief_row 0 monk_druid_code
    END
  END
BUT_ONLY


/*
COPY_EXISTING ~d5drnf.spl~ ~override~
  PATCH_IF VARIABLE_IS_SET %fighter_druid_code% BEGIN
	LPF CLONE_EFFECT INT_VAR multi_match = 1 match_opcode = 177 match_target = 1 match_parameter2 = 9 parameter1 = %fighter_druid_code% STR_VAR resource = ~d5drsc1~ END
  END
  PATCH_IF VARIABLE_IS_SET %mage_druid_code% BEGIN
	LPF CLONE_EFFECT INT_VAR multi_match = 1 match_opcode = 177 match_target = 1 match_parameter2 = 9 parameter1 = %mage_druid_code% STR_VAR resource = ~d5drsc1~ END
  END
  PATCH_IF VARIABLE_IS_SET %ranger_druid_code% BEGIN
	LPF CLONE_EFFECT INT_VAR multi_match = 1 match_opcode = 177 match_target = 1 match_parameter2 = 9 parameter1 = %ranger_druid_code% STR_VAR resource = ~d5drsc1~ END
  END
  PATCH_IF VARIABLE_IS_SET %thief_druid_code% BEGIN
	LPF CLONE_EFFECT INT_VAR multi_match = 1 match_opcode = 177 match_target = 1 match_parameter2 = 9 parameter1 = %thief_druid_code% STR_VAR resource = ~d5drsc1~ END
  END
  PATCH_IF VARIABLE_IS_SET %monk_druid_code% BEGIN
	LPF CLONE_EFFECT INT_VAR multi_match = 1 match_opcode = 177 match_target = 1 match_parameter2 = 9 parameter1 = %monk_druid_code% STR_VAR resource = ~d5drsc1~ END
  END
BUT_ONLY
*/

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									FIGHTER/DRUID
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION fighter_druid BEGIN

//MULTICLASS DRUID FILES______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~d5dfor.2da~ ~override/d5drfi.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~clabdr01.2da~ ~override/d5drfi.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
APPEND ~d5drfi.2da~ ~NO_TURN     AP_D5_NOTU  AP_D5_NOTU  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5_NOTU~
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~d5drfi.2da~ ~WILDSHAPE   AP_D5SC000  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
WILDSHAPE   AP_D5SC8L   ****        ****        GA_D5SC00A  ****        ****        ****        GA_D5SC00B  ****        ****        ****        GA_D5SC00C  ****        ****        AP_D5SC10L  ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END


//ADD KIT____________________________________________________________________________
//
LAF check_kit_conflict END

LAF ADD_KIT_EX 
  INT_VAR
    kit_class  = 8
    lower      = RESOLVE_STR_REF(@45101)
    mixed      = RESOLVE_STR_REF(@45102)
    help       = RESOLVE_STR_REF(@45103)
    briefdesc  = RESOLVE_STR_REF(@45103)
  STR_VAR
    kit_name    = ~D5_DR_FIGHTER~
    clab_base_p = ~override/d5drfi.2da~
    unusable    = ~0x08000000~	//	totemic exclusion flag
//                                         T   S           F   Q             S S
//                 L S                     W   C           L   U             W I
//                 A M             B L S   O   I   W       A   A             O N
//                 R A             A O H   H   M   A       I   R C   S       R G
//                 G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//                 E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//                 S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//                 W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//                 O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//                 R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//                 D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
    clasweap    = ~1 1 1 1 1 0 0 1~
    weapprof    = ~0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 2 0 2 2 0 0 0 2 0 0 0 2 2 2 0 2 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~
//                 ST DX CO IN WI CH
    abclasrq    = ~9  0  0  0  12 12~
    abclsmod    = ~0  0  0  0  0  0~
    abdcdsrq    = ~17 0  0  0  17 0~
    abdcscrq    = ~15 0  0  0  15 0~
//                 LG LN LE NG TN NE CG CN CE
    alignmnt    = ~0  1  0  1  1  1  0  1  0~
//                 F C M T D R
    dualclas    = ~0 0 0 0 0 0~
//                 HU E  HE D  HL G  HO
    clsrcreq    = ~1  1  1  1  1  1  1~
    kittable    = ~K_FC_H K_FC_G K_FC_E K_FC_HE K_FC_HL K_FC_HO~
    luabbr      = ~FD0~
    clswpbon    = ~1 0 2~
    stweap      = ~LEAT14	* HELM07 BAG20 RING06 RING31 CLCK02 BOOT01 AMUL19 BRAC16 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H39 STAF08~
  RET D5_DR_FIGHTER = kit_id
END

//SHAPESHIFT/ALIGNMENT/KIT TEXT______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
  COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols 
    READ_2DA_ENTRIES_NOW rows cols 
    FOR (row = 1; row < rows; ++row) BEGIN 
      READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
      READ_2DA_ENTRY_FORMER rows row 0 kit_code
      PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FIGHTER~ BEGIN
        SET fighter_druid_code = kit_code
      END
    END
  BUT_ONLY
  COPY_EXISTING ~d5sc000.spl~ ~override~
    PATCH_IF (VARIABLE_IS_SET %fighter_druid_code%) BEGIN
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %fighter_druid_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5sc08l~ END
    END
  BUT_ONLY
  <<<<<<<< d5/d5sctmp.baf

  >>>>>>>>
  COPY ~d5/d5sctmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  COPY_EXISTING ~d5sclst.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols feat_kit
      PATCH_IF (~%feat_kit%~ STRING_EQUAL_CASE ~D5_DR_FIGHTER~) BEGIN
        FOR (row = 1; row < rows; ++row) BEGIN
          READ_2DA_ENTRY row col cols val
          PATCH_PRINT ~%feat_kit% - %row% - %val%~
          PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
            INNER_ACTION BEGIN
              APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),"%feat_kit%")
THEN
	RESPONSE #100
	SetGlobal("D5SC%row%","GLOBAL",1)
	Continue()
END
~
            END // end inner action
          END
        END // end rows
      END
    END // end cols
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5scdlg.bcs~) BEGIN
    EXTEND_TOP ~d5scdlg.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~alignmnt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FIGHTER~) BEGIN
		SET_2DA_ENTRY row 2 10 1
		SET_2DA_ENTRY row 4 10 1
		SET_2DA_ENTRY row 6 10 1
		SET_2DA_ENTRY row 8 10 1
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 1 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FIGHTER~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  ACTION_FOR_EACH text IN ~clastext~ ~sodcltxt~ ~bgclatxt~ BEGIN
    ACTION_IF (FILE_EXISTS_IN_GAME ~%text%.2da~) BEGIN
      COPY_EXISTING ~%text%.2da~ ~override~
	    COUNT_2DA_ROWS 10 rows
	    FOR (row = 1; row < rows; ++row) BEGIN
	      READ_2DA_ENTRY row 0 10 kit_name
	      PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
	    	READ_2DA_ENTRY row 4 10 nudru_desc
	      END
	      PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FIGHTER~) BEGIN
	    	SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	      END
	    END
      BUT_ONLY
    END
  END
END

//NO SPHERE SYSTEM____________________________________________________________________
//
 ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  LAF no_spheres_druid_spells STR_VAR clab_table = ~d5drfi~ END
 END
 
//HLAs_______________________________________________________________________________
//
LAF action_remove_hla STR_VAR kit_name = ~D5_DR_FIGHTER~ remove_ability = ~AP_D5PHLA5~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_FIGHTER~ ability = ~AP_D5PHLA4~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_FIGHTER~ ability = ~GA_TG#SPIR~ num_allowed = ~1~ END

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 2
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 2
	u_axes 				= 0
	u_daggers 			= 2
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 2
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 2
	u_darts 			= 2
	u_slings	 		= 2
	u_bows 				= 2
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5drfi~
	sphere_list		= ~druid_forest_spheres~
	class 			= ~fighter_cleric~
 END

 ACTION_IF FILE_EXISTS_IN_GAME ~K_FD_H.2da~ BEGIN
  COPY_EXISTING ~K_FD_H.2da~ ~override~
	COUNT_2DA_ROWS 2 rows
	PATCH_IF (rows < 2) BEGIN
	  INNER_ACTION BEGIN
		COPY_EXISTING ~clsrcreq.2da~ ~override~
		  COUNT_2DA_ROWS 8 rows
		  FOR (row = 0 ; row < rows ; ++row) BEGIN
	    	READ_2DA_ENTRY row 0 8 entry
			PATCH_IF (~%entry%~ STRING_COMPARE_CASE ~FIGHTER_DRUID~ = 0) BEGIN
			  SET_2DA_ENTRY  row 1 8 0
			  SET_2DA_ENTRY  row 2 8 0
			  SET_2DA_ENTRY  row 3 8 0
			  SET_2DA_ENTRY  row 4 8 0
			  SET_2DA_ENTRY  row 5 8 0
			  SET_2DA_ENTRY  row 6 8 0
			  SET_2DA_ENTRY  row 7 8 0
			END
		  END
		BUT_ONLY
	  END
	END
  BUT_ONLY
 END

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfor~) BEGIN
	  SET new_druid_row = row
	END
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfi~) && (VARIABLE_IS_SET %new_druid_row%) BEGIN
	  READ_2DA_ENTRY new_druid_row 4 10 druid_desc
	  SET_2DA_ENTRY row 4 10 druid_desc
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
    LAF fnp_spontaneous STR_VAR kit_clab = ~d5drfi~ learn_res = ~d5drfiz~ END
  END
 END

// ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
//	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5drfi~ END
// END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5drfi~ END
 END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									DRUID/RANGER
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION druid_ranger BEGIN

//MULTICLASS DRUID FILES______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~d5dfor.2da~ ~override/d5drra.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~clabdr01.2da~ ~override/d5drra.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
APPEND ~d5drra.2da~ ~NO_TURN     AP_D5_NOTU  AP_D5_NOTU  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~

ACTION_IF (FILE_EXISTS_IN_GAME ~d5__imp_rangers.d5~) BEGIN
  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__rfeat.d5~) BEGIN
	APPEND ~d5drra.2da~ ~TRACKING    GA_SPCL922  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~
  END
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5__rfeat.d5~) BEGIN
	APPEND ~d5drra.2da~ ~FEATS       AP_D5_RFF1  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~
	ACTION_IF !(GAME_IS ~iwdee~) BEGIN
	  APPEND ~d5drra.2da~ ~FEATS       AP_D5_RFA9  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~
	END
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__stride.d5~) BEGIN
  APPEND ~d5drra.2da~ ~STRIDE      AP_SPCL151  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~ UNLESS ~STRIDE~
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~d5drra.2da~ ~WILDSHAPE   AP_D5SC000  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
WILDSHAPE   AP_D5SC2L   ****        ****        GA_D5SC00A  ****        ****        ****        GA_D5SC00B  ****        ****        ****        GA_D5SC00C  ****        ****        AP_D5SC10L  ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END

//ADD KIT____________________________________________________________________________
//
LAF check_kit_conflict END

LAF ADD_KIT_EX 
  INT_VAR
    kit_class  = 18
    lower      = RESOLVE_STR_REF(@45201)
    mixed      = RESOLVE_STR_REF(@45202)
    help       = RESOLVE_STR_REF(@45103)
    briefdesc  = RESOLVE_STR_REF(@45103)
  STR_VAR
    kit_name    = ~D5_DR_RANGER~
    clab_base_p = ~override/d5drra.2da~
    unusable    = ~0x08000000~	//	totemic exclusion flag
//                                         T   S           F   Q             S S
//                 L S                     W   C           L   U             W I
//                 A M             B L S   O   I   W       A   A             O N
//                 R A             A O H   H   M   A       I   R C   S       R G
//                 G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//                 E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//                 S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//                 W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//                 O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//                 R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//                 D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
    clasweap    = ~1 1 1 1 1 0 0 1~
    weapprof    = ~0 0 0 0 0 0 0 0 0 0 0 0 0 0 2 2 0 2 2 0 0 0 2 0 0 0 2 2 2 0 2 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~
//                 ST DX CO IN WI CH
    abclasrq    = ~0  0  12 0  12 12~
    abclsmod    = ~0  0  0  0  0  0~
    abdcdsrq    = ~0  0  17 0  17 0~
    abdcscrq    = ~0  0  15 0  15 0~
//                 LG LN LE NG TN NE CG CN CE
    alignmnt    = ~0  1  0  1  1  1  0  1  0~
//                 F C M T D R
    dualclas    = ~0 0 0 0 0 0~
//                 HU E  HE D  HL G  HO
    clsrcreq    = ~1  1  1  1  1  1  1~
    kittable    = ~K_CR_D K_CR_E K_CR_G K_CR_H K_CR_HE K_CR_HL K_CR_HO~
    luabbr      = ~FD0~
    clswpbon    = ~1 0 2~
    stweap      = ~LEAT14	* HELM07 BAG20 RING06 RING31 CLCK02 BOOT01 AMUL19 BRAC16 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H39 STAF08~
  RET D5_DR_RANGER = kit_id
END

//SHAPESHIFT/ALIGNMENT/KIT TEXT______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
  COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols 
    READ_2DA_ENTRIES_NOW rows cols 
    FOR (row = 1; row < rows; ++row) BEGIN 
      READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
      READ_2DA_ENTRY_FORMER rows row 0 kit_code
      PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_RANGER~ BEGIN
        SET ranger_druid_code = kit_code
      END
    END
  BUT_ONLY
  COPY_EXISTING ~d5sc000.spl~ ~override~
    PATCH_IF (VARIABLE_IS_SET %ranger_druid_code%) BEGIN
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %ranger_druid_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5sc12l~ END
    END
  BUT_ONLY
  <<<<<<<< d5/d5sctmp.baf

  >>>>>>>>
  COPY ~d5/d5sctmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  COPY_EXISTING ~d5sclst.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols feat_kit
      PATCH_IF (~%feat_kit%~ STRING_EQUAL_CASE ~D5_DR_RANGER~) BEGIN
        FOR (row = 1; row < rows; ++row) BEGIN
          READ_2DA_ENTRY row col cols val
          PATCH_PRINT ~%feat_kit% - %row% - %val%~
          PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
            INNER_ACTION BEGIN
              APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),"%feat_kit%")
THEN
	RESPONSE #100
	SetGlobal("D5SC%row%","GLOBAL",1)
	Continue()
END
~
            END // end inner action
          END
        END
      END // end rows
    END // end cols
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5scdlg.bcs~) BEGIN
    EXTEND_TOP ~d5scdlg.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~alignmnt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_RANGER~) BEGIN
		SET_2DA_ENTRY row 2 10 1
		SET_2DA_ENTRY row 4 10 1
		SET_2DA_ENTRY row 6 10 1
		SET_2DA_ENTRY row 8 10 1
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 1 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_RANGER~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~clastext.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_RANGER~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~sodcltxt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_RANGER~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
END

//NO SPHERE SYSTEM____________________________________________________________________
//
 ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  LAF no_spheres_druid_spells STR_VAR clab_table = ~d5drra~ END
 END
 
//HLAs_______________________________________________________________________________
//
LAF action_remove_hla STR_VAR kit_name = ~D5_DR_RANGER~ remove_ability = ~AP_D5PHLA5~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_RANGER~ ability = ~AP_D5PHLA4~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_RANGER~ ability = ~GA_TG#SPIR~ num_allowed = ~1~ END

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 2
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 2
	u_axes 				= 0
	u_daggers 			= 2
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 2
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 2
	u_darts 			= 2
	u_slings	 		= 2
	u_bows 				= 2
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5drra~
	sphere_list		= ~druid_forest_spheres~
	class 			= ~ranger_cleric~
 END

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfor~) BEGIN
	  SET new_druid_row = row
	END
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drra~) && (VARIABLE_IS_SET %new_druid_row%) BEGIN
	  READ_2DA_ENTRY new_druid_row 4 10 druid_desc
	  SET_2DA_ENTRY row 4 10 druid_desc
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
    LAF fnp_spontaneous STR_VAR kit_clab = ~d5drra~ learn_res = ~d5drraz~ END
  END
 END

// ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
//	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5drra~ END
// END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5drra~ END
 END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									DRUID/THIEF
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION druid_thief BEGIN

//MULTICLASS DRUID FILES______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~d5dfor.2da~ ~override/d5drth.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~clabdr01.2da~ ~override/d5drth.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
APPEND ~d5drth.2da~ ~NO_TURN     AP_D5_NOTU  AP_D5_NOTU  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~d5drth.2da~ ~WILDSHAPE   AP_D5SC000  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
WILDSHAPE   AP_D5SC1L   ****        ****        GA_D5SC00A  ****        ****        ****        GA_D5SC00B  ****        ****        ****        GA_D5SC00C  ****        ****        AP_D5SC00D  ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END

//ADD KIT____________________________________________________________________________
//
LAF check_kit_conflict END

LAF ADD_KIT_EX 
  INT_VAR
    kit_class  = 15
    lower      = RESOLVE_STR_REF(@45301)
    mixed      = RESOLVE_STR_REF(@45302)
    help       = RESOLVE_STR_REF(@45103)
    briefdesc  = RESOLVE_STR_REF(@45103)
  STR_VAR
    kit_name    = ~D5_DR_THIEF~
    clab_base_p = ~override/d5drth.2da~
    unusable    = ~0x08000000~	//	totemic exclusion flag
//                                         T   S           F   Q             S S
//                 L S                     W   C           L   U             W I
//                 A M             B L S   O   I   W       A   A             O N
//                 R A             A O H   H   M   A       I   R C   S       R G
//                 G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//                 E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//                 S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//                 W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//                 O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//                 R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//                 D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
    clasweap    = ~1 1 1 1 1 0 0 1~
    weapprof    = ~0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 1 0 0 0 1 0 0 0 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~
//                 ST DX CO IN WI CH
    abclasrq    = ~0  12 0  0  12 12~
    abclsmod    = ~0  0  0  0  0  0~
    abdcdsrq    = ~0  17 0  0  17 0~
    abdcscrq    = ~0  15 0  0  15 0~
//                 LG LN LE NG TN NE CG CN CE
    alignmnt    = ~0  1  0  1  1  1  0  1  0~
//                 F C M T D R
    dualclas    = ~0 0 0 0 0 0~
//                 HU E  HE D  HL G  HO
    clsrcreq    = ~1  1  1  1  1  1  1~
    kittable    = ~K_CT_D K_CT_E K_CT_G K_CT_H K_CT_HE K_CT_HL K_CT_HO~
    luabbr      = ~CT0~
    clswpbon    = ~0 0 2~
    stweap      = ~LEAT14	* HELM07 BAG20 RING06 RING31 CLCK02 BOOT01 AMUL19 BRAC16 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H39 STAF08~
  RET D5_DR_THIEF = kit_id
END

//SHAPESHIFT/ALIGNMENT/KIT TEXT______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
  COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols 
    READ_2DA_ENTRIES_NOW rows cols 
    FOR (row = 1; row < rows; ++row) BEGIN 
      READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
      READ_2DA_ENTRY_FORMER rows row 0 kit_code
      PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_THIEF~ BEGIN
        SET thief_druid_code = kit_code
      END
    END
  BUT_ONLY
  COPY_EXISTING ~d5sc000.spl~ ~override~
    PATCH_IF (VARIABLE_IS_SET %thief_druid_code%) BEGIN
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %thief_druid_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5sc02l~ END
    END
  BUT_ONLY
  <<<<<<<< d5/d5sctmp.baf

  >>>>>>>>
  COPY ~d5/d5sctmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  COPY_EXISTING ~d5sclst.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols feat_kit
      PATCH_IF (~%feat_kit%~ STRING_EQUAL_CASE ~D5_DR_THIEF~) BEGIN
        FOR (row = 1; row < rows; ++row) BEGIN
          READ_2DA_ENTRY row col cols val
          PATCH_PRINT ~%feat_kit% - %row% - %val%~
          PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
            INNER_ACTION BEGIN
              APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),"%feat_kit%")
THEN
	RESPONSE #100
	SetGlobal("D5SC%row%","GLOBAL",1)
	Continue()
END
~
            END // end inner action
          END
        END
      END // end rows
    END // end cols
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5scdlg.bcs~) BEGIN
    EXTEND_TOP ~d5scdlg.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~alignmnt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_THIEF~) BEGIN
		SET_2DA_ENTRY row 2 10 1
		SET_2DA_ENTRY row 4 10 1
		SET_2DA_ENTRY row 6 10 1
		SET_2DA_ENTRY row 8 10 1
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 1 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_THIEF~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~clastext.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_THIEF~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~sodcltxt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_THIEF~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
END

//NO SPHERE SYSTEM____________________________________________________________________
//
 ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  LAF no_spheres_druid_spells STR_VAR clab_table = ~d5drth~ END
 END
 
//HLAs_______________________________________________________________________________
//
LAF action_remove_hla STR_VAR kit_name = ~D5_DR_THIEF~ remove_ability = ~AP_D5PHLA5~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_THIEF~ ability = ~AP_D5PHLA4~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_THIEF~ ability = ~GA_TG#SPIR~ num_allowed = ~1~ END

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 1
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 1
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 1
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5drth~
	sphere_list		= ~druid_forest_spheres~
	class 			= ~cleric_thief~
 END

 ACTION_IF FILE_EXISTS_IN_GAME ~CLSRCREQ.2da~ BEGIN
  COPY_EXISTING ~clsrcreq.2da~ ~override~
	COUNT_2DA_ROWS 8 rows
	FOR (row = 0 ; row < rows ; ++row) BEGIN
      READ_2DA_ENTRY row 0 8 entry
      PATCH_IF (~%entry%~ STRING_COMPARE_CASE ~CLERIC_THIEF~ = 0) BEGIN
    	SET_2DA_ENTRY  row 3 8 1
      END
    END
  BUT_ONLY
 END

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfor~) BEGIN
	  SET new_druid_row = row
	END
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drth~) && (VARIABLE_IS_SET %new_druid_row%) BEGIN
	  READ_2DA_ENTRY new_druid_row 4 10 druid_desc
	  SET_2DA_ENTRY row 4 10 druid_desc
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
    LAF fnp_spontaneous STR_VAR kit_clab = ~d5drth~ learn_res = ~d5drthz~ END
  END
 END

// ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
//	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5drth~ END
// END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5drth~ END
 END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									DRUID/MAGE
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION druid_mage BEGIN

//MULTICLASS DRUID FILES______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~d5dfor.2da~ ~override/d5drma.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~clabdr01.2da~ ~override/d5drma.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
APPEND ~d5drma.2da~ ~NO_TURN     AP_D5_NOTU  AP_D5_NOTU  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~d5drma.2da~ ~WILDSHAPE   AP_D5SC000  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
WILDSHAPE   AP_D5SC2L   ****        ****        GA_D5SC00A  ****        ****        ****        GA_D5SC00B  ****        ****        ****        GA_D5SC00C  ****        ****        AP_D5SC00D  ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END

//ADD KIT____________________________________________________________________________
//
LAF check_kit_conflict END

LAF ADD_KIT_EX 
  INT_VAR
    kit_class  = 14
    lower      = RESOLVE_STR_REF(@45401)
    mixed      = RESOLVE_STR_REF(@45402)
    help       = RESOLVE_STR_REF(@45103)
    briefdesc  = RESOLVE_STR_REF(@45103)
  STR_VAR
    kit_name    = ~D5_DR_MAGE~
    clab_base_p = ~override/d5drma.2da~
    unusable    = ~0x08000000~	//	totemic exclusion flag
//                                         T   S           F   Q             S S
//                 L S                     W   C           L   U             W I
//                 A M             B L S   O   I   W       A   A             O N
//                 R A             A O H   H   M   A       I   R C   S       R G
//                 G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//                 E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//                 S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//                 W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//                 O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//                 R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//                 D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
    clasweap    = ~1 1 1 1 1 0 0 1~
    weapprof    = ~0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 1 0 0 0 1 0 0 0 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~
//                 ST DX CO IN WI CH
    abclasrq    = ~0  0  0  12 12 12~
    abclsmod    = ~0  0  0  0  0  0~
    abdcdsrq    = ~0  0  0  17 17 0~
    abdcscrq    = ~0  0  0  15 15 0~
//                 LG LN LE NG TN NE CG CN CE
    alignmnt    = ~0  1  0  1  1  1  0  1  0~
//                 F C M T D R
    dualclas    = ~0 0 0 0 0 0~
//                 HU E  HE D  HL G  HO
    clsrcreq    = ~1  1  1  0  0  1  1~
    kittable    = ~K_CM_E K_CM_G K_CM_H K_CM_HE K_CM_HO~
    luabbr      = ~CM0~
    clswpbon    = ~0 0 2~
    stweap      = ~LEAT14	* HELM07 BAG20 RING06 RING31 CLCK02 BOOT01 AMUL19 BRAC16 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H39 STAF08~
  RET D5_DR_MAGE = kit_id
END

//SHAPESHIFT/ALIGNMENT/KIT TEXT______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
  COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols 
    READ_2DA_ENTRIES_NOW rows cols 
    FOR (row = 1; row < rows; ++row) BEGIN 
      READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
      READ_2DA_ENTRY_FORMER rows row 0 kit_code
      PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MAGE~ BEGIN
        SET mage_druid_code = kit_code
      END
    END
  BUT_ONLY
  COPY_EXISTING ~d5sc000.spl~ ~override~
    PATCH_IF (VARIABLE_IS_SET %mage_druid_code%) BEGIN
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %mage_druid_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5sc02l~ END
    END
  BUT_ONLY
  <<<<<<<< d5/d5sctmp.baf

  >>>>>>>>
  COPY ~d5/d5sctmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  COPY_EXISTING ~d5sclst.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols feat_kit
      PATCH_IF (~%feat_kit%~ STRING_EQUAL_CASE ~D5_DR_MAGE~) BEGIN
        FOR (row = 1; row < rows; ++row) BEGIN
          READ_2DA_ENTRY row col cols val
          PATCH_PRINT ~%feat_kit% - %row% - %val%~
          PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
            INNER_ACTION BEGIN
              APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),"%feat_kit%")
THEN
	RESPONSE #100
	SetGlobal("D5SC%row%","GLOBAL",1)
	Continue()
END
~
            END // end inner action
          END
        END
      END // end rows
    END // end cols
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5scdlg.bcs~) BEGIN
    EXTEND_TOP ~d5scdlg.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~alignmnt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MAGE~) BEGIN
		SET_2DA_ENTRY row 2 10 1
		SET_2DA_ENTRY row 4 10 1
		SET_2DA_ENTRY row 6 10 1
		SET_2DA_ENTRY row 8 10 1
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 1 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MAGE~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~clastext.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MAGE~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~sodcltxt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MAGE~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
END

//NO SPHERE SYSTEM____________________________________________________________________
//
 ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  LAF no_spheres_druid_spells STR_VAR clab_table = ~d5drma~ END
 END

//HLAs_______________________________________________________________________________
//
LAF action_remove_hla STR_VAR kit_name = ~D5_DR_MAGE~ remove_ability = ~AP_D5PHLA5~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_MAGE~ ability = ~AP_D5PHLA4~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_MAGE~ ability = ~GA_TG#SPIR~ num_allowed = ~1~ END
 
//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 0
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 1
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 1
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5drma~
	sphere_list		= ~druid_forest_spheres~
	class 			= ~cleric_mage~
 END

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfor~) BEGIN
	  SET new_druid_row = row
	END
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drma~) && (VARIABLE_IS_SET %new_druid_row%) BEGIN
	  READ_2DA_ENTRY new_druid_row 4 10 druid_desc
	  SET_2DA_ENTRY row 4 10 druid_desc
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
    LAF fnp_spontaneous STR_VAR kit_clab = ~d5drma~ learn_res = ~d5drmaz~ END
  END
 END

// ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
//	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = d5drma~~ END
// END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5drma~ END
 END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									SORCERER/DRUID
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION sorcerer_druid BEGIN

//MULTICLASS DRUID FILES_____________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~d5dfor.2da~ ~override/d5drsrc.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~clabdr01.2da~ ~override/d5drsrc.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
APPEND ~d5drsrc.2da~ ~NO_TURN     AP_D5_NOTU  AP_D5_NOTU  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~d5drsrc.2da~ ~WILDSHAPE   AP_D5SC000  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
WILDSHAPE   AP_D5SC2L   ****        ****        GA_D5SC00A  ****        ****        ****        GA_D5SC00B  ****        ****        ****        GA_D5SC00C  ****        ****        AP_D5SC00D  ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END

//ADD KIT____________________________________________________________________________
//
LAF check_kit_conflict END

LAF ADD_KIT_EX 
  INT_VAR
    kit_class  = 14
    lower      = RESOLVE_STR_REF(@45501)
    mixed      = RESOLVE_STR_REF(@45502)
    help       = RESOLVE_STR_REF(@45103)
    briefdesc  = RESOLVE_STR_REF(@45103)
  STR_VAR
    kit_name    = ~D5_DR_SORC~
    clab_base_p = ~override/d5drsrc.2da~
    clab_base_m = ~override/d5fsorc.2da~
    unusable    = ~0x08000000~	//	totemic exclusion flag
//                                         T   S           F   Q             S S
//                 L S                     W   C           L   U             W I
//                 A M             B L S   O   I   W       A   A             O N
//                 R A             A O H   H   M   A       I   R C   S       R G
//                 G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//                 E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//                 S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//                 W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//                 O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//                 R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//                 D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
    clasweap    = ~1 1 1 1 1 0 0 1~
    weapprof    = ~0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 1 0 0 0 1 0 0 0 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~
//                 ST DX CO IN WI CH
    abclasrq    = ~0  0  0  0  12 12~
    abclsmod    = ~0  0  0  0  0  0~
    abdcdsrq    = ~0  0  0  0  17 17~
    abdcscrq    = ~0  0  0  0  15 15~
//                 LG LN LE NG TN NE CG CN CE
    alignmnt    = ~0  1  0  1  1  1  0  1  0~
//                 F C M T D R
    dualclas    = ~0 0 0 0 0 0~
//                 HU E  HE D  HL G  HO
    clsrcreq    = ~1  1  1  0  0  1  1~
    kittable    = ~K_CM_E K_CM_G K_CM_H K_CM_HE K_CM_HO~
    luabbr      = ~CM0~
    clswpbon    = ~0 0 2~
    stweap      = ~LEAT14	* HELM07 BAG20 RING06 RING31 CLCK02 BOOT01 AMUL19 BRAC16 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H39 STAF08~
  RET D5_DR_SORC = kit_id
END

//SHAPESHIFT/ALIGNMENT/KIT TEXT______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
  COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols 
    READ_2DA_ENTRIES_NOW rows cols 
    FOR (row = 1; row < rows; ++row) BEGIN 
      READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
      READ_2DA_ENTRY_FORMER rows row 0 kit_code
      PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_SORC~ BEGIN
        SET sorcerer_druid_code = kit_code
      END
    END
  BUT_ONLY
  COPY_EXISTING ~d5sc000.spl~ ~override~
    PATCH_IF (VARIABLE_IS_SET %sorcerer_druid_code%) BEGIN
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %sorcerer_druid_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5sc02l~ END
    END
  BUT_ONLY
  <<<<<<<< d5/d5sctmp.baf

  >>>>>>>>
  COPY ~d5/d5sctmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  COPY_EXISTING ~d5sclst.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols feat_kit
      PATCH_IF (~%feat_kit%~ STRING_EQUAL_CASE ~D5_DR_SORC~) BEGIN
        FOR (row = 1; row < rows; ++row) BEGIN
          READ_2DA_ENTRY row col cols val
          PATCH_PRINT ~%feat_kit% - %row% - %val%~
          PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
            INNER_ACTION BEGIN
              APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),"%feat_kit%")
THEN
	RESPONSE #100
	SetGlobal("D5SC%row%","GLOBAL",1)
	Continue()
END
~
            END // end inner action
          END
        END
      END // end rows
    END // end cols
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5scdlg.bcs~) BEGIN
    EXTEND_TOP ~d5scdlg.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~alignmnt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_SORC~) BEGIN
		SET_2DA_ENTRY row 2 10 1
		SET_2DA_ENTRY row 4 10 1
		SET_2DA_ENTRY row 6 10 1
		SET_2DA_ENTRY row 8 10 1
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 1 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_SORC~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~clastext.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_SORC~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~sodcltxt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_SORC~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
END

//NO SPHERE SYSTEM___________________________________________________________________
//
 ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  LAF no_spheres_druid_spells STR_VAR clab_table = ~d5drsrc~ END
 END

//HLAs_______________________________________________________________________________
//
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~GA_SPWI920~ ability = ~GA_D5HL920~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~GA_SPWI921~ ability = ~GA_D5HL921~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~GA_SPWI922~ ability = ~GA_D5HL922~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~GA_SPWI923~ ability = ~GA_D5HL923~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~GA_SPWI924~ ability = ~GA_D5HL924~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~GA_SPWI925~ ability = ~GA_D5HL925~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~AP_SPWI928~ ability = ~AP_D5HL928~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~AP_SPWI929~ ability = ~AP_D5HL929~ END
LAF action_replace_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~AP_SPWI930~ ability = ~AP_D5HL930~ END
LAF action_remove_hla STR_VAR kit_name = ~D5_DR_SORC~ remove_ability = ~AP_D5PHLA5~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_SORC~ ability = ~AP_D5PHLA4~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_SORC~ ability = ~GA_TG#SPIR~ num_allowed = ~1~ END
 
//DEFINE SPHERE ACCESS_______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 0
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 1
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 1
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5drsrc~
	sphere_list		= ~druid_forest_spheres~
	class 			= ~cleric_mage~
 END

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfor~) BEGIN
	  SET new_druid_row = row
	END
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drma~) && (VARIABLE_IS_SET %new_druid_row%) BEGIN
	  READ_2DA_ENTRY new_druid_row 4 10 druid_desc
	  SET_2DA_ENTRY row 4 10 druid_desc
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
    LAF fnp_spontaneous STR_VAR kit_clab = ~d5drsrc~ learn_res = ~d5drsrz~ END
  END
 END

// ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
//	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5drsrc~ END
// END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5drsrc~ END
 END

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									DRUID/MONK
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION druid_monk BEGIN

//MULTICLASS DRUID FILES______________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~d5dfor.2da~ ~override/d5drmnk.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~clabdr01.2da~ ~override/d5drmnk.2da~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789] ~ ~ ****      ~
	REPLACE_TEXTUALLY ~ AP_D5_U[0123456789][0123456789][0123456789] ~ ~ ****       ~
	REPLACE_TEXTUALLY ~ AP_QD_MCD[0123456789][0123456789] ~ ~ ****      ~
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
APPEND ~d5drmnk.2da~ ~NO_TURN     AP_D5_NOTU  AP_D5_NOTU  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~d5drmnk.2da~ ~WILDSHAPE   AP_D5SC000  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
WILDSHAPE   AP_D5SC2L   ****        ****        GA_D5SC00A  ****        ****        ****        GA_D5SC00B  ****        ****        ****        GA_D5SC00C  ****        ****        AP_D5SC00D  ****        ****        ****        ****        ****     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END

//ADD KIT____________________________________________________________________________
//
LAF check_kit_conflict END

LAF ADD_KIT_EX 
  INT_VAR
    kit_class  = 15
    lower      = RESOLVE_STR_REF(@45601)
    mixed      = RESOLVE_STR_REF(@45602)
    help       = RESOLVE_STR_REF(@45103)
    briefdesc  = RESOLVE_STR_REF(@45103)
  STR_VAR
    kit_name    = ~D5_DR_MONK~
    clab_base_p = ~override/d5drmnk.2da~
    clab_base_t = ~override/QDMONK_C.2da~
    unusable    = ~0x08000000~	//	totemic exclusion flag
//                                         T   S           F   Q             S S
//                 L S                     W   C           L   U             W I
//                 A M             B L S   O   I   W       A   A             O N
//                 R A             A O H   H   M   A       I   R C   S       R G
//                 G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//                 E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//                 S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//                 W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//                 O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//                 R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//                 D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
    clasweap    = ~1 1 1 1 1 0 0 1~
    weapprof    = ~0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 0 1 0 0 0 0 0 0 0 0 1 1 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~
//                 ST DX CO IN WI CH
    abclasrq    = ~0  12 0  0  12 12~
    abclsmod    = ~0  0  0  0  0  0~
    abdcdsrq    = ~0  17 0  0  17 0~
    abdcscrq    = ~0  15 0  0  15 0~
//                 LG LN LE NG TN NE CG CN CE
    alignmnt    = ~0  1  0  1  1  1  0  1  0~
//                 F C M T D R
    dualclas    = ~0 0 0 0 0 0~
//                 HU E  HE D  HL G  HO
    clsrcreq    = ~1  1  1  0  0  0  1~
    kittable    = ~K_CT_E K_CT_H K_CT_HE K_CT_HO~
    luabbr      = ~DR0~
    clswpbon    = ~1 0 2~
    stweap      = ~LEAT14	* HELM07 BAG20 RING06 RING31 CLCK02 BOOT01 AMUL19 BRAC16 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H39 STAF08~
  RET D5_DR_MONK = kit_id
END

//SHAPESHIFT/ALIGNMENT/KIT TEXT______________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5sc000.spl~) BEGIN
  APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
  COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kit.ids~ ~override~
    COUNT_2DA_COLS cols 
    READ_2DA_ENTRIES_NOW rows cols 
    FOR (row = 1; row < rows; ++row) BEGIN 
      READ_2DA_ENTRY_FORMER rows row 1 ~kit_name~ 
      READ_2DA_ENTRY_FORMER rows row 0 kit_code
      PATCH_IF ~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MONK~ BEGIN
        SET monk_druid_code = kit_code
      END
    END
  BUT_ONLY
  COPY_EXISTING ~d5sc000.spl~ ~override~
    PATCH_IF (VARIABLE_IS_SET %monk_druid_code%) BEGIN
      LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %monk_druid_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5sc02l~ END
    END
  BUT_ONLY
  <<<<<<<< d5/d5sctmp.baf

  >>>>>>>>
  COPY ~d5/d5sctmp.baf~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  COPY_EXISTING ~d5sclst.2da~ ~override~
    COUNT_2DA_COLS cols
    COUNT_2DA_ROWS cols rows
    FOR (col = 1; col < cols; ++col) BEGIN
      READ_2DA_ENTRY 0 col cols feat_kit
      PATCH_IF (~%feat_kit%~ STRING_EQUAL_CASE ~D5_DR_MONK~) BEGIN
        FOR (row = 1; row < rows; ++row) BEGIN
          READ_2DA_ENTRY row col cols val
          PATCH_PRINT ~%feat_kit% - %row% - %val%~
          PATCH_IF (~%val%~ STRING_EQUAL_CASE ~1~) BEGIN
            INNER_ACTION BEGIN
              APPEND_OUTER ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~ 
~
IF
	NumberOfTimesTalkedTo(0)
	Kit(LastSummonerOf(Myself),"%feat_kit%")
THEN
	RESPONSE #100
	SetGlobal("D5SC%row%","GLOBAL",1)
	Continue()
END
~
            END // end inner action
          END
        END
      END // end rows
    END // end cols
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5scdlg.bcs~) BEGIN
    EXTEND_TOP ~d5scdlg.bcs~ ~weidu_external/%MOD_FOLDER%/compile/d5sctmp.baf~
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5dfor.2da~) BEGIN
  COPY_EXISTING ~alignmnt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MONK~) BEGIN
		SET_2DA_ENTRY row 2 10 1
		SET_2DA_ENTRY row 4 10 1
		SET_2DA_ENTRY row 6 10 1
		SET_2DA_ENTRY row 8 10 1
	  END
	END
  BUT_ONLY
  COPY_EXISTING ~kitlist.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 1 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MONK~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~clastext.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MONK~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
  COPY_EXISTING ~sodcltxt.2da~ ~override~
	COUNT_2DA_ROWS 10 rows
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY row 0 10 kit_name
	  PATCH_IF (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_FOR~) BEGIN
		READ_2DA_ENTRY row 4 10 nudru_desc
	  END
	  PATCH_IF (VARIABLE_IS_SET %nudru_desc%) && (~%kit_name%~ STRING_EQUAL_CASE ~D5_DR_MONK~) BEGIN
		SET_2DA_ENTRY row 4 10 nudru_desc // or do: RESOLVE_STR_REF (@73103)
	  END
	END
  IF_EXISTS BUT_ONLY
END

//NO SPHERE SYSTEM____________________________________________________________________
//
 ACTION_IF !(MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  LAF no_spheres_druid_spells STR_VAR clab_table = ~d5drmnk~ END
 END
 
//HLAs_______________________________________________________________________________
//
LAF action_remove_hla STR_VAR kit_name = ~D5_DR_MONK~ remove_ability = ~AP_D5PHLA5~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_MONK~ ability = ~AP_D5PHLA4~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_DR_MONK~ ability = ~GA_TG#SPIR~ num_allowed = ~1~ END
// give monk HLAs too!!

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 0
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 0
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 0
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5drmnk~
	sphere_list		= ~druid_forest_spheres~
	class 			= ~cleric_thief~
 END

 ACTION_IF FILE_EXISTS_IN_GAME ~CLSRCREQ.2da~ BEGIN
  COPY_EXISTING ~clsrcreq.2da~ ~override~
	COUNT_2DA_ROWS 8 rows
	FOR (row = 0 ; row < rows ; ++row) BEGIN
      READ_2DA_ENTRY row 0 8 entry
      PATCH_IF (~%entry%~ STRING_COMPARE_CASE ~D5_DR_MONK~ = 0) BEGIN
    	SET_2DA_ENTRY  row 3 8 1
      END
    END
  BUT_ONLY
 END

 COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab_name
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drfor~) BEGIN
	  SET new_druid_row = row
	END
	PATCH_IF (~%clab_name%~ STRING_EQUAL_CASE ~d5drmnk~) && (VARIABLE_IS_SET %new_druid_row%) BEGIN
	  READ_2DA_ENTRY new_druid_row 4 10 druid_desc
	  SET_2DA_ENTRY row 4 10 druid_desc
	END
  END
 BUT_ONLY

 ACTION_IF (FILE_EXISTS_IN_GAME ~d5__fnp_spont_option.d5~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
    LAF fnp_spontaneous STR_VAR kit_clab = ~d5drmnk~ learn_res = ~d5drmkz~ END
  END
 END

// ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
//	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5drMNK~ END
// END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5drmnk~ END
  COPY_EXISTING ~weapprof.2da~ ~override~
	COUNT_2DA_COLS cols
	SET kit_cols = (cols - 1)
	SET kit_col = (cols - 2)
	SET_2DA_ENTRY 23 kit_col kit_cols 0
  BUT_ONLY
 END

//MULTICLASS KIT______________________________________________________________________
//
 /*
 ACTION_IF !(FILE_EXISTS_IN_GAME ~monkhlas.2da~) BEGIN
  COPY_EXISTING ~LUMO0.2da~ ~override/monkhlas.2da~
 END
*/
 COPY_EXISTING ~LUMO0.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 1 10 monk_ability
	PATCH_IF !(~%monk_ability%~ STRING_EQUAL_CASE ~*~) BEGIN
	  SNPRINT 3 hla_type ~%monk_ability%~
	  PATCH_IF (~%hla_type%~ STRING_EQUAL_CASE ~GA_~) || (~%hla_type%~ STRING_EQUAL_CASE ~AP_~) BEGIN
		READ_2DA_ENTRY row 2 10 monk_icon
		READ_2DA_ENTRY row 3 10 monk_strref
		READ_2DA_ENTRY row 4 10 monk_min_lev
		READ_2DA_ENTRY row 5 10 monk_max_level
		READ_2DA_ENTRY row 6 10 monk_num_allowed
		READ_2DA_ENTRY row 7 10 monk_prerequisite
		READ_2DA_ENTRY row 8 10 monk_excluded_by
		READ_2DA_ENTRY row 9 10 monk_alignment_restrict
		INNER_ACTION BEGIN
		  LAF action_add_hla STR_VAR kit_name = ~D5_DR_MONK~ ability = EVAL ~%monk_ability%~ icon = EVAL ~%monk_icon%~ strref = EVAL ~%monk_strref%~ min_lev = EVAL ~%monk_min_lev%~ max_level = EVAL ~%monk_max_level%~ num_allowed = EVAL ~%monk_num_allowed%~ prerequisite = EVAL ~%monk_prerequisite%~ excluded_by = EVAL ~%monk_excluded_by%~ alignment_restrict = EVAL ~%monk_alignment_restrict%~ END
		END
	  END
	END
  END
 IF_EXISTS BUT_ONLY

END	//	end function
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//								MULTI DRUID STRONGHOLDS
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION multi_druid_strongholds BEGIN

ACTION_IF GAME_IS ~bg2ee eet~ BEGIN

<<<<<<<< d5/cechall+.d
EXTEND_BOTTOM CECHALLE 2

 IF ~LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	!Global("GaveTitle","LOCALS",1)
	OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN REPLY #55515  DO ~ClearAllActions()

StartCutSceneMode()

StartCutSceneEx("Cut63a",FALSE)

~ EXIT

 IF ~LevelLT(Player1,14)
	Global("GreatDruid","GLOBAL",0)
	!Global("GaveTitle","LOCALS",1)
	OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN REPLY #58673  EXIT
END

EXTEND_BOTTOM CECHALLE 4
  IF ~  Global("CerndChallenge","GLOBAL",0)
	Global("PlayerHasStronghold","GLOBAL",0)
	OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN DO ~SetGlobal("SPRITE_IS_DEADFaldorn","GLOBAL",1)
SetGlobal("SPRITE_IS_DEADcefaldor","GLOBAL",1)
SetNumTimesTalkedTo(1)
~ GOTO 7
END
>>>>>>>> 
COMPILE ~d5/cechall+.d~

<<<<<<<< d5/cefaldo+.d
EXTEND_BOTTOM CEFALDOR 2

  IF ~See(Player1)
	!StateCheck(Player1,STATE_SLEEPING)
	OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN REPLY #9621  GOTO 13

  IF ~ !Name("Jaheira",Player2)
	!Name("Cernd",Player2)
	See(Player2)
	!StateCheck(Player2,STATE_SLEEPING)
	OR(4)
	  Kit(Player2,D5_DR_FIGHTER)
	  Kit(Player2,D5_DR_RANGER)
	  Kit(Player2,D5_DR_THIEF)
	  Kit(Player2,D5_DR_MAGE)
~ THEN REPLY #9948  GOTO 22

  IF ~ !Name("Jaheira",Player3)
	!Name("Cernd",Player3)
	See(Player3)
	!StateCheck(Player3,STATE_SLEEPING)
	OR(4)
	  Kit(Player3,D5_DR_FIGHTER)
	  Kit(Player3,D5_DR_RANGER)
	  Kit(Player3,D5_DR_THIEF)
	  Kit(Player3,D5_DR_MAGE)
~ THEN REPLY #9952  GOTO 22

  IF ~ !Name("Jaheira",Player4)
	!Name("Cernd",Player4)
	See(Player4)
	!StateCheck(Player4,STATE_SLEEPING)
	OR(4)
	  Kit(Player4,D5_DR_FIGHTER)
	  Kit(Player4,D5_DR_RANGER)
	  Kit(Player4,D5_DR_THIEF)
	  Kit(Player4,D5_DR_MAGE)
~ THEN REPLY #9953  GOTO 22

  IF ~ !Name("Jaheira",Player5)
	!Name("Cernd",Player5)
	See(Player5)
	!StateCheck(Player5,STATE_SLEEPING)
	OR(4)
	  Kit(Player5,D5_DR_FIGHTER)
	  Kit(Player5,D5_DR_RANGER)
	  Kit(Player5,D5_DR_THIEF)
	  Kit(Player5,D5_DR_MAGE)
~ THEN REPLY #9954  GOTO 22

  IF ~ !Name("Jaheira",Player6)
	!Name("Cernd",Player6)
	See(Player6)
	!StateCheck(Player6,STATE_SLEEPING)
	OR(4)
	  Kit(Player6,D5_DR_FIGHTER)
	  Kit(Player6,D5_DR_RANGER)
	  Kit(Player6,D5_DR_THIEF)
	  Kit(Player6,D5_DR_MAGE)
~ THEN REPLY #9955  GOTO 22
END

EXTEND_BOTTOM CEFALDOR 5

  IF ~ OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN REPLY #9866  DO ~SetGlobal("TalkedFaldor1","GLOBAL",1)
~ GOTO 0
END
>>>>>>>> 
COMPILE ~d5/cefaldo+.d~

<<<<<<<< d5/druidad+.d
EXTEND_BOTTOM DRUIDAD 0

  IF ~ LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN GOTO 1
END

EXTEND_BOTTOM DRUIDAD 10
  IF ~ LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player1,D5_DR_FIGHTER)
	  Kit(Player1,D5_DR_RANGER)
	  Kit(Player1,D5_DR_THIEF)
	  Kit(Player1,D5_DR_MAGE)
~ THEN GOTO 11

  IF ~ False()
	LevelGT(Player2,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player2,D5_DR_FIGHTER)
	  Kit(Player2,D5_DR_RANGER)
	  Kit(Player2,D5_DR_THIEF)
	  Kit(Player2,D5_DR_MAGE)
~ THEN GOTO 12

  IF ~ False()
	LevelGT(Player3,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player3,D5_DR_FIGHTER)
	  Kit(Player3,D5_DR_RANGER)
	  Kit(Player3,D5_DR_THIEF)
	  Kit(Player3,D5_DR_MAGE)
~ THEN GOTO 13

  IF ~ False()
	LevelGT(Player4,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player4,D5_DR_FIGHTER)
	  Kit(Player4,D5_DR_RANGER)
	  Kit(Player4,D5_DR_THIEF)
	  Kit(Player4,D5_DR_MAGE)
~ THEN GOTO 14

  IF ~ False()
	LevelGT(Player5,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player5,D5_DR_FIGHTER)
	  Kit(Player5,D5_DR_RANGER)
	  Kit(Player5,D5_DR_THIEF)
	  Kit(Player5,D5_DR_MAGE)
~ THEN GOTO 15

  IF ~ False()
	LevelGT(Player6,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player6,D5_DR_FIGHTER)
	  Kit(Player6,D5_DR_RANGER)
	  Kit(Player6,D5_DR_THIEF)
	  Kit(Player6,D5_DR_MAGE)
~ THEN GOTO 16
END
>>>>>>>> 
COMPILE ~d5/druidad+.d~


ACTION_IF (FILE_EXISTS_IN_GAME ~d5drsrc.2da~) BEGIN

<<<<<<<< d5/cechall-.d
EXTEND_BOTTOM CECHALLE 2

 IF ~LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	!Global("GaveTitle","LOCALS",1)
	Kit(Player1,D5_DR_SORC)
~ THEN REPLY #55515  DO ~ClearAllActions()

StartCutSceneMode()

StartCutSceneEx("Cut63a",FALSE)

~ EXIT

 IF ~LevelLT(Player1,14)
	Global("GreatDruid","GLOBAL",0)
	!Global("GaveTitle","LOCALS",1)
	  Kit(Player1,D5_DR_SORC)
~ THEN REPLY #58673  EXIT
END

EXTEND_BOTTOM CECHALLE 4
  IF ~  Global("CerndChallenge","GLOBAL",0)
	Global("PlayerHasStronghold","GLOBAL",0)
	  Kit(Player1,D5_DR_SORC)
~ THEN DO ~SetGlobal("SPRITE_IS_DEADFaldorn","GLOBAL",1)
SetGlobal("SPRITE_IS_DEADcefaldor","GLOBAL",1)
SetNumTimesTalkedTo(1)
~ GOTO 7
END
>>>>>>>> 
COMPILE ~d5/cechall-.d~

<<<<<<<< d5/cefaldo-.d
EXTEND_BOTTOM CEFALDOR 2

  IF ~See(Player1)
	!StateCheck(Player1,STATE_SLEEPING)
	  Kit(Player1,D5_DR_SORC)
~ THEN REPLY #9621  GOTO 13

  IF ~ !Name("Jaheira",Player2)
	!Name("Cernd",Player2)
	See(Player2)
	!StateCheck(Player2,STATE_SLEEPING)
	  Kit(Player2,D5_DR_SORC)
~ THEN REPLY #9948  GOTO 22

  IF ~ !Name("Jaheira",Player3)
	!Name("Cernd",Player3)
	See(Player3)
	!StateCheck(Player3,STATE_SLEEPING)
	  Kit(Player3,D5_DR_SORC)
~ THEN REPLY #9952  GOTO 22

  IF ~ !Name("Jaheira",Player4)
	!Name("Cernd",Player4)
	See(Player4)
	!StateCheck(Player4,STATE_SLEEPING)
	  Kit(Player4,D5_DR_SORC)
~ THEN REPLY #9953  GOTO 22

  IF ~ !Name("Jaheira",Player5)
	!Name("Cernd",Player5)
	See(Player5)
	!StateCheck(Player5,STATE_SLEEPING)
	  Kit(Player5,D5_DR_SORC)
~ THEN REPLY #9954  GOTO 22

  IF ~ !Name("Jaheira",Player6)
	!Name("Cernd",Player6)
	See(Player6)
	!StateCheck(Player6,STATE_SLEEPING)
	  Kit(Player6,D5_DR_SORC)
~ THEN REPLY #9955  GOTO 22
END

EXTEND_BOTTOM CEFALDOR 5

  IF ~ Kit(Player1,D5_DR_SORC)
~ THEN REPLY #9866  DO ~SetGlobal("TalkedFaldor1","GLOBAL",1)
~ GOTO 0
END
>>>>>>>> 
COMPILE ~d5/cefaldo-.d~

<<<<<<<< d5/druidad-.d
EXTEND_BOTTOM DRUIDAD 0

  IF ~ LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player1,D5_DR_SORC)
~ THEN GOTO 1
END

EXTEND_BOTTOM DRUIDAD 10
  IF ~ LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player1,D5_DR_SORC)
~ THEN GOTO 11

  IF ~ False()
	LevelGT(Player2,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player2,D5_DR_SORC)
~ THEN GOTO 12

  IF ~ False()
	LevelGT(Player3,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player3,D5_DR_SORC)
~ THEN GOTO 13

  IF ~ False()
	LevelGT(Player4,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player4,D5_DR_SORC)
~ THEN GOTO 14

  IF ~ False()
	LevelGT(Player5,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player5,D5_DR_SORC)
~ THEN GOTO 15

  IF ~ False()
	LevelGT(Player6,13)
	Global("GreatDruid","GLOBAL",0)
	  Kit(Player6,D5_DR_SORC)
~ THEN GOTO 16
END
>>>>>>>> 
COMPILE ~d5/druidad-.d~

END

END

END // end function
//__________________________________________________________________________________


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


DEFINE_ACTION_FUNCTION multiclass_shaman_item STR_VAR kit_clab = ~x~ learn_res = ~d5msham~ BEGIN

COPY_EXISTING ~kitlist.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 5 10 clab
	PATCH_IF (~%clab%~ STRING_EQUAL_CASE ~%kit_clab%~) BEGIN
	  READ_2DA_ENTRY row 8 10 kit_class
	  READ_2DA_ENTRY row 9 10 kit_ids
	END
  END
BUT_ONLY

APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
BUT_ONLY

//recreate shamanic dance_____________________________________________________________
//
// leave out the movement check... just stop movement and reenable it upon canceling dance
// patch to 50% movement if the 'improved shamanic dance' mod is installed

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shmdn.spl~) BEGIN
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdn.bam~ ~override~		//	dance icon
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdn.spl~ ~override~		//	dance ability
    SAY NAME1 @1021// Shamanic Dance
    SAY UNIDENTIFIED_DESC @1021 
    LPF ALTER_SPELL_HEADER INT_VAR location = 4 STR_VAR icon = ~d5shmdn~ END
//	LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5nshdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 177 match_timing = 1 timing = 0 duration = 126144000 STR_VAR match_resource = ~d5shmdnb~ END
    PATCH_IF (MOD_IS_INSTALLED ~A7#ImprovedShamanicDance.tp2~ ~0~) BEGIN
 	  LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 176 match_parameter1 = 0 parameter1 = 50 parameter2 = 2 END
    END
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdnb.eff~ ~override~		//	232 eff triggered by song
/*
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdnb.spl~ ~override~		//	aura triggered by 232 eff
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 318 STR_VAR match_resource = ~spsh004~ resource = ~d5shmdnb~ END
*/
  COPY_EXISTING ~spsh004.spl~ ~override/d5shmdnb.spl~
    SAY NAME1 @1021// Shamanic Dance
    SAY UNIDENTIFIED_DESC @1021 
    LPF ALTER_SPELL_HEADER INT_VAR location = 4 STR_VAR icon = ~d5shmdn~ END
    LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 318 STR_VAR match_resource = ~spsh004~ resource = ~d5shmdnb~ END
    LPF DELETE_EFFECT INT_VAR check_globals = 0 match_opcode = 363 END
    LPF DELETE_EFFECT INT_VAR check_globals = 0 match_opcode = 146 STR_VAR match_resource = ~spsh003~ END
    
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5nshdn.bam~ ~override~		//	stop dance icon
/*
  COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5nshdn.spl~				//	stop dance abil
    SAY NAME1 @1023 // Stop Shamanic Dance
    SAY UNIDENTIFIED_DESC @1023 
    LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5nshdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5nshdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
*/
  CREATE EFF ~d5shmdn~
	WRITE_LONG 0x10 171
	WRITE_LONG 0x14 1
	WRITE_LONG 0x24 9
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5shmdn~ #8
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5SHMDN~ #8
END

//recreate detect illusions__________________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shmdi.spl~) BEGIN
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdi.bam~ ~override~		//	detect icon
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdi.spl~ ~override~		//	detect ability
    SAY NAME1 @1024 // Detect Illusions
    SAY UNIDENTIFIED_DESC @1024 
    LPF ALTER_SPELL_HEADER INT_VAR location = 4 STR_VAR icon = ~d5shmdi~ END
// 	LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5nshdi~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdi~ END
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdib.eff~ ~override~							//	232 eff triggered by song
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdib.spl~ ~override~							//	aura triggered by 232 eff
  COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5nshdi.bam~ ~override~		//	stop detect icon
/*
  COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5nshdi.spl~				//	stop detect abil
    SAY NAME1 @1026 // Stop detecting illusions
    SAY UNIDENTIFIED_DESC @1026 
    LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5nshdi~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5nshdi~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
*/
  CREATE EFF ~d5shmdi~
	WRITE_LONG 0x10 171
	WRITE_LONG 0x14 1
	WRITE_LONG 0x24 9
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5shmdi~ #8
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5SHMDI~ #8
END

//learn spell item_____________________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~%learn_res%b.spl~) BEGIN
  COPY_EXISTING ~%learn_res%b.spl~ ~override~
	LPF ALTER_EFFECT INT_VAR match_opcode = 143 STR_VAR resource = ~d5shamb~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdn~ END
	PATCH_IF !(%kit_class% = 15) BEGIN
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdi~ END
	END
  BUT_ONLY
END
 
ACTION_IF (FILE_EXISTS_IN_GAME ~d5shamb.itm~) BEGIN
 COPY_EXISTING ~d5shamb.itm~ ~override~												//	learn spells .itm
  LPF ADD_ITEM_EFFECT INT_VAR header = 3 opcode = 326 target = 1 parameter1 = %kit_ids% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_res%~ END
END
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shamb.itm~) BEGIN
 COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shamb.itm~ ~override~		//	learn spells .itm
  SAY NAME1 @1011
  SAY NAME2 @1011
  SAY UNIDENTIFIED_DESC @1012
  SAY IDENTIFIED_DESC @1012
  LPF ALTER_ITEM_HEADER INT_VAR header = 1 target = 7 speed = 0 STR_VAR icon = ~d5nshdn~ END
  LPF ALTER_ITEM_HEADER INT_VAR header = 2 target = 7 speed = 0 STR_VAR icon = ~d5nshdi~ END
  LPF ADD_ITEM_EFFECT INT_VAR header = 2 insert_point = 0 opcode = 318 target = 1 parameter1 = 15 parameter2 = 105 timing = 0 duration = 0 STR_VAR resource = EVAL ~%SOURCE_RES%~ END
  LPF ALTER_ITEM_HEADER INT_VAR header = 3 target = 7 speed = 0 STR_VAR icon = ~spcl919b~ END
  LPF DELETE_EFFECT INT_VAR silent = 1 match_opcode = 146 END
  LPF ADD_ITEM_EFFECT INT_VAR header = 3 opcode = 326 target = 1 parameter1 = %kit_ids% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_res%~ END
END

OUTER_INNER_PATCH ~1~ BEGIN
  WRITE_BYTE 0 0x09
  READ_ASCII 0 tab (1)  // 0x09, tab
  WRITE_BYTE 0 0x0d
  READ_ASCII 0 mnl (1)  // 0x0d, Mac
END
LAF ~ADD_ITEM_TOOLTIPS~ STR_VAR item = ~d5shamb~ tooltips = ~@1021 @1024 @1011~ END

/*
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shamb.eff~) BEGIN
  CREATE EFF ~d5shamb~
	WRITE_LONG 0x10 143
	WRITE_LONG 0x14 1
	WRITE_LONG 0x24 9
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5shamb~ #8
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~d5shamb~ #8
*/

/* do this in d5shami instead
ACTION_IF (FILE_EXISTS_IN_GAME ~d5fpspt.spl~) BEGIN
  COPY_EXISTING ~d5fpspt.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdn~ END
	PATCH_IF !(%kit_class% = 15) BEGIN
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdi~ END
	END
END
*/

ACTION_IF (FILE_EXISTS_IN_GAME ~d5shmsp.spl~) BEGIN
  COPY_EXISTING ~d5shmsp.spl~ ~override~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 318 insert_point = 0 target = 1 parameter1 = %kit_ids% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = ~d5shmsp~ END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5shmsw.spl~) BEGIN
  COPY_EXISTING ~d5shmsw.spl~ ~override~
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 318 insert_point = 0 target = 1 parameter1 = %kit_ids% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = ~d5shmsw~ END
END

END	//	end item function


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//								BARBARIAN/SHAMAN
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION sham_barb BEGIN

LAF check_kit_conflict END

ADD_KIT ~D5_BARB_SHAMAN~

//WEAPON PROFICIENCIES________________________________________________________________
//11                                            T   S           F   Q             S S
//10          	 		L S                     W   C           L   U             W I
//9     	       		A M             B L S   O   I   W       A   A             O N
//8     	       		R A             A O H   H   M   A       I   R C   S       R G
//7     	       		G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//6     	       		E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//5     	       		S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//4     	       		W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//3     	       		O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//2     	       		R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//1     	       		D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
~D5_BARB_SHAMAN  		0 0 0 0 0 0 0 0~
~D5_BARB_SHAMAN    		0 0 0 0 0 0 0 0 0 0 0 2 0 0 2 2 0 2 2 0 2 0 2 0 2 2 2 2 2 0 2 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~

//MINIMUM KIT STATS_________________________________________________________________
//  	               STR DEX CON INT WIS CHR
~D5_BARB_SHAMAN   		0   0   0   0   0   0~

//KIT STAT MODIFIERS________________________________________________________________
//      	           STR DEX CON INT WIS CHR
~D5_BARB_SHAMAN   		0   0   0   0   0   0~

//REQUIREMENTS TO DUAL TO THIS KIT_________________________________________________
//          	       STR DEX CON INT WIS CHR
~D5_BARB_SHAMAN   		0   0   0   0   0   0~

//REQUIREMENTS TO DUAL FROM THIS KIT________________________________________________
//              	   STR DEX CON INT WIS CHR
~D5_BARB_SHAMAN  		0   0   0   0   0   0~

//ALIGNMENT RESTRICTIONS____________________________________________________________
//                 	   LG LN LE NG TN NE CG CN CE
~D5_BARB_SHAMAN  		0  0  0  1  1  1  0  0  0~

//DUAL CLASS OPTIONS________________________________________________________________
//      	           	FT CL MA TH DR RA
~D5_BARB_SHAMAN    		0  0  0  0  0  0~

//KIT ABILITIES 2DA FILE______________________________________________________________
~faiths_and_powers/kits/multiclass/499_shambarb/d5shmbb.2da~

//RACIAL KIT AVAILABILITY_____________________________________________________________
~K_FC_H K_FC_HE K_FC_HO~

//UNUSABLE FLAGS AND KIT BASE CLASS_________________________________________________
//CLASSES: Mage = 1, Fighter = 2, Cleric=3, Thief = 4, Bard = 5
//         Paladin 6, Druid = 11, Ranger = 12, Sorcerer = 19
//         Monk = 20, FC = 8, CT = 15, CR = 18, FM = 7, CM = 14, MT = 13
~0x08000000 8~	//	totemic

//HIGH LEVEL ABILITIES ABBREVIATION_________________________________________________
~FC0~

//TOB STARTING EQUIPMENT_____________________________________________________________
~CHAN09	* HELM07 BAG26 RING06 RING31 * BOOT01 AMUL20 BRAC10 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H27 STAF08~

//CHARACTER CREATION KIT DESCRIPTION________________________________________________
SAY @49901
SAY @49902
SAY @49903

//EE KIT EXTRAS_____________________________________________________________________
// 
ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ THEN BEGIN
	LAF fl#add_kit_ee
		INT_VAR
			briefdesc = RESOLVE_STR_REF (@49903)
		STR_VAR
			kit_name = D5_BARB_SHAMAN
			clswpbon = ~1 0 3~
			hpclass = ~HPFC~
			clsrcreq = ~1 0 1 0 0 0 1~
	END
END

//MULTICLASS SHAMAN FILES______________________________________________________________
//
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmbb.2da~ ~override~
APPEND ~d5shmbb.2da~ ~CAST_INIT   AP_D5FPSPT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPSPT~
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END

// ***** give access to vanilla_shaman_spheres

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 1
	u_maces 	 		= 0
	u_flails 			= 1
	u_axes 				= 1
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 0
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 1
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 1
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5shmbb~
	class 			= ~fighter_cleric~
//	class 			= ~mystic~
	sphere_list		= ~vanilla_shaman_spheres~
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
	LAF fnp_spontaneous STR_VAR kit_clab = ~d5shmbb~ learn_res = ~d5shmbz~ END
	LAF multiclass_shaman_item STR_VAR kit_clab = ~d5shmbb~ learn_res = ~d5shmbz~ END
  END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5shmbb~ END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5shmbb~ END
 END

 LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_BARB_SHAMAN~ 
		kit_clab = ~d5shmbb~
		base_class = ~P~
 END

//GET KIT IDS_________________________________________________________________________
//
 OUTER_SET shambarb_code = (0x4000 + %D5_BARB_SHAMAN%)

//5E CASTING COMPAT___________________________________________________________________
// add 318 effects to exempt multisham from 5E casting
 APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
 COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
 BUT_ONLY
 ACTION_FOR_EACH 5e_spl IN ~d5zz000~ ~d5zzini~ /*~d5zlots~*/ ~d5zltcl~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%5e_spl%.spl~) BEGIN
    COPY_EXISTING ~%5e_spl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = %shambarb_code% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = EVAL ~%5e_spl%~ END
    BUT_ONLY
  END
 END

END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//								  SHAMAN/RANGER
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION ranger_shaman BEGIN

LAF check_kit_conflict END

ADD_KIT ~D5_SHAMAN_RANGER~

//WEAPON PROFICIENCIES________________________________________________________________
//11        	                             T   S           F   Q             S S
//10        	     L S                     W   C           L   U             W I
//9         	     A M             B L S   O   I   W       A   A             O N
//8         	     R A             A O H   H   M   A       I   R C   S       R G
//7         	     G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//6         	     E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//5         	     S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//4         	     W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//3         	     O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//2         	     R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//1         	     D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
~D5_SHAMAN_RANGER    0 0 0 0 0 0 0 0~
~D5_SHAMAN_RANGER    0 0 0 0 0 0 0 0 0 0 0 2 0 0 2 2 0 2 2 0 2 0 2 0 2 2 2 2 2 0 2 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~

//MINIMUM KIT STATS_________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_RANGER        0   0   9   0   11  0~

//KIT STAT MODIFIERS________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_RANGER        0   0   0   0   0   0~

//REQUIREMENTS TO DUAL TO THIS KIT_________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_RANGER        0   0   17  0   17  0~

//REQUIREMENTS TO DUAL FROM THIS KIT________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_RANGER        0   0   15  0   15  0~

//ALIGNMENT RESTRICTIONS____________________________________________________________
//                  	LG LN LE NG TN NE CG CN CE
~D5_SHAMAN_RANGER        0  0  0  1  0  0  0  0  0~

//DUAL CLASS OPTIONS________________________________________________________________
//                  	FT CL MA TH DR RA
~D5_SHAMAN_RANGER        0  0  0  0  0  0~

//KIT ABILITIES 2DA FILE______________________________________________________________
~faiths_and_powers/kits/multiclass/496_shamranger/d5shmrn.2da~

//RACIAL KIT AVAILABILITY_____________________________________________________________
~K_CR_H K_CR_HE K_CR_HO~

//UNUSABLE FLAGS AND KIT BASE CLASS_________________________________________________
//CLASSES: Mage = 1, Fighter = 2, Cleric=3, Thief = 4, Bard = 5
//         Paladin 6, Druid = 11, Ranger = 12, Sorcerer = 19
//         Monk = 20
~0x08000000 18~ // totemic

//HIGH LEVEL ABILITIES ABBREVIATION_________________________________________________
~CR0~

//TOB STARTING EQUIPMENT_____________________________________________________________
~CHAN09	* HELM07 BAG26 RING06 RING31 * BOOT01 AMUL20 BRAC10 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H27 STAF08~

//CHARACTER CREATION KIT DESCRIPTION________________________________________________
SAY @49601
SAY @49602
SAY @49603

//EE KIT EXTRAS_____________________________________________________________________
// 
ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ THEN BEGIN
	LAF fl#add_kit_ee
		INT_VAR
			briefdesc = RESOLVE_STR_REF (@49603)
		STR_VAR
			kit_name = D5_SHAMAN_RANGER
			clswpbon = ~1 0 2~
			clsrcreq = ~1 0 1 0 0 0 1~
	END
END

//MULTICLASS SHAMAN FILES____________________________________________________________
//
COPY ~faiths_and_powers/kits/multiclass/496_shamranger/d5shmrn.2da~ ~override~
/*
  PATCH_IF (FILE_EXISTS_IN_GAME ~d5rfor.2da~) BEGIN
	APPEND_FILE ~faiths_and_powers/kits/rangers/901_forest_ranger/ranger_goodberry.txt~
	APPEND_FILE ~faiths_and_powers/kits/rangers/901_forest_ranger/ranger_enemies.txt~
  END
*/
// cast this vv in d5yinit
// APPEND ~d5shmrn.2da~ ~CAST_INIT   AP_D5FPSPT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPSPT~
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END

ACTION_IF (FILE_EXISTS_IN_GAME ~d5__imp_rangers.d5~) BEGIN
  ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__rfeat.d5~) BEGIN
	APPEND ~d5shmrn.2da~ ~TRACKING    GA_SPCL922  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~
  END
  ACTION_IF (FILE_EXISTS_IN_GAME ~d5__rfeat.d5~) BEGIN
	APPEND ~d5shmrn.2da~ ~FEATS       AP_D5_RFF1  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~
	ACTION_IF !(GAME_IS ~iwdee~) BEGIN
	  APPEND ~d5shmrn.2da~ ~FEATS       AP_D5_RFA9  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~
	END
  END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__stride.d5~) BEGIN
  APPEND ~d5shmrn.2da~ ~STRIDE      AP_SPCL151  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****         ****        ****        ****        ****        ****        ****  ~ UNLESS ~STRIDE~
END

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 2
	u_hammers	 		= 2
	u_maces 	 		= 0
	u_flails 			= 2
	u_axes 				= 2
	u_daggers 			= 2
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 0
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 2
	u_darts 			= 2
	u_slings	 		= 2
	u_bows 				= 2
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5shmrn~
	class 			= ~ranger_cleric~
//	class 			= ~mystic~
	sphere_list		= ~vanilla_shaman_spheres~
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
	LAF fnp_spontaneous STR_VAR kit_clab = ~d5shmrn~ learn_res = ~d5shrnz~ END
	LAF multiclass_shaman_item STR_VAR kit_clab = ~d5shmrn~ learn_res = ~d5shrnz~ END
  END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5shmrn~ END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5shmrn~ END
 END

 LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_RANGER~ 
		kit_clab = ~d5shmrn~
		base_class = ~P~
 END

//GET KIT IDS_________________________________________________________________________
//
 OUTER_SET shamran_code = (0x4000 + %D5_SHAMAN_RANGER%)

//5E CASTING COMPAT___________________________________________________________________
// add 318 effects to exempt multisham from 5E casting
 APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
 COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
 BUT_ONLY
 ACTION_FOR_EACH 5e_spl IN ~d5zz000~ ~d5zzini~ /*~d5zlots~*/ ~d5zltcl~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%5e_spl%.spl~) BEGIN
    COPY_EXISTING ~%5e_spl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = %shamran_code% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = EVAL ~%5e_spl%~ END
    BUT_ONLY
  END
 END

END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									SHAMAN/THIEF
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION shaman_thief BEGIN

LAF check_kit_conflict END

ADD_KIT ~D5_SHAMAN_THIEF~

//WEAPON PROFICIENCIES________________________________________________________________
//11             	                        T   S           F   Q             S S
//10             	L S                     W   C           L   U             W I
//9              	A M             B L S   O   I   W       A   A             O N
//8              	R A             A O H   H   M   A       I   R C   S       R G
//7              	G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//6              	E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//5              	S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//4              	W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//3              	O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//2              	R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//1              	D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
~D5_SHAMAN_THIEF    0 0 0 0 0 0 0 0~
~D5_SHAMAN_THIEF    0 0 0 0 0 0 0 0 0 1 1 0 0 0 1 1 0 1 0 0 0 0 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~

//MINIMUM KIT STATS_________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_THIEF         0   9   0   0   11  0~

//KIT STAT MODIFIERS________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_THIEF         0   0   0   0   0   0~

//REQUIREMENTS TO DUAL TO THIS KIT_________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_THIEF         0   17  0   0   17  0~

//REQUIREMENTS TO DUAL FROM THIS KIT________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_THIEF         0   15  0   0   15  0~

//ALIGNMENT RESTRICTIONS____________________________________________________________
//                  	LG LN LE NG TN NE CG CN CE
~D5_SHAMAN_THIEF         0  0  0  1  1  1  0  0  0~

//DUAL CLASS OPTIONS________________________________________________________________
//                  	FT CL MA TH DR RA
~D5_SHAMAN_THIEF         0  0  0  0  0  0~

//KIT ABILITIES 2DA FILE______________________________________________________________
~faiths_and_powers/kits/multiclass/497_shamthief/d5shmth.2da~

//RACIAL KIT AVAILABILITY_____________________________________________________________
~K_CT_H K_CT_HE K_CT_HO~

//UNUSABLE FLAGS AND KIT BASE CLASS_________________________________________________
//CLASSES: Mage = 1, Fighter = 2, Cleric=3, Thief = 4, Bard = 5
//         Paladin 6, Druid = 11, Ranger = 12, Sorcerer = 19
//         Monk = 20
~0x08000000 15~ // totemic

//HIGH LEVEL ABILITIES ABBREVIATION_________________________________________________
~CT0~

//TOB STARTING EQUIPMENT_____________________________________________________________
~CHAN09	* HELM07 BAG26 RING06 RING31 * BOOT01 AMUL20 BRAC10 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H27 STAF08~

//CHARACTER CREATION KIT DESCRIPTION________________________________________________
SAY @49701
SAY @49702
SAY @49703

//EE KIT EXTRAS______________________________________________________________________
// 
ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ THEN BEGIN
	LAF fl#add_kit_ee
		INT_VAR
			briefdesc = RESOLVE_STR_REF (@49703)
		STR_VAR
			kit_name = D5_SHAMAN_THIEF
			clswpbon = ~0 0 3~
			clsrcreq = ~1 0 1 0 0 0 1~
	END
END

//MULTICLASS SHAMAN FILES____________________________________________________________
//
COPY ~faiths_and_powers/kits/multiclass/497_shamthief/d5shmth.2da~ ~override~
// APPEND ~d5shmth.2da~ ~CAST_INIT   AP_D5FPSPT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPSPT~
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5dil10.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 276 target = 1 parameter1 = 10 parameter2 = 0 timing = 9 END
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5dil04.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 276 target = 1 parameter1 = 4 parameter2 = 0 timing = 9 END
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5tshdi.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5shmdi~ END


//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 1
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 1
	u_long_swords		= 0
	u_scimitars 		= 1
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 1
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 1
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5shmth~
	class 			= ~cleric_thief~
//	class 			= ~mystic~
	sphere_list		= ~vanilla_shaman_spheres~
  END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
	LAF fnp_spontaneous STR_VAR kit_clab = ~d5shmth~ learn_res = ~d5shthz~ END
	LAF multiclass_shaman_item STR_VAR kit_clab = ~d5shmth~ learn_res = ~d5shthz~ END
  END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5shmth~ END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5shmth~ END
 END

 LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_THIEF~ 
		kit_clab = ~d5shmth~
		base_class = ~P~
 END

//GET KIT IDS_________________________________________________________________________
//
 OUTER_SET shamthief_code = (0x4000 + %D5_SHAMAN_THIEF%)

//5E CASTING COMPAT___________________________________________________________________
// add 318 effects to exempt multisham from 5E casting
 APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
 COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
 BUT_ONLY
 ACTION_FOR_EACH 5e_spl IN ~d5zz000~ ~d5zzini~ /*~d5zlots~*/ ~d5zltcl~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%5e_spl%.spl~) BEGIN
    COPY_EXISTING ~%5e_spl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = %shamthief_code% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = EVAL ~%5e_spl%~ END
    BUT_ONLY
  END
 END

END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									SHAMAN/MAGE
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION shaman_mage BEGIN

LAF check_kit_conflict END

ADD_KIT ~D5_SHAMAN_MAGE~

//WEAPON PROFICIENCIES_______________________________________________________________
//11             	                        T   S           F   Q             S S
//10             	L S                     W   C           L   U             W I
//9              	A M             B L S   O   I   W       A   A             O N
//8              	R A             A O H   H   M   A       I   R C   S       R G
//7              	G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//6              	E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//5              	S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//4              	W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//3              	O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//2              	R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//1              	D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
~D5_SHAMAN_MAGE     0 0 0 0 0 0 0 0~
~D5_SHAMAN_MAGE     0 0 0 0 0 0 0 0 0 0 1 0 0 0 1 1 0 1 1 0 1 0 1 0 0 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~

//MINIMUM KIT STATS_________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MAGE          0   0   0   0   11  0~

//KIT STAT MODIFIERS________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MAGE          0   0   0   0   0   0~

//REQUIREMENTS TO DUAL TO THIS KIT_________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MAGE          0   0   0   0   17  0~

//REQUIREMENTS TO DUAL FROM THIS KIT________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MAGE          0   0   0   0   15  0~

//ALIGNMENT RESTRICTIONS____________________________________________________________
//                  	LG LN LE NG TN NE CG CN CE
~D5_SHAMAN_MAGE          0  0  0  1  1  1  0  0  0~

//DUAL CLASS OPTIONS________________________________________________________________
//                  	FT CL MA TH DR RA
~D5_SHAMAN_MAGE          0  0  0  0  0  0~

//KIT ABILITIES 2DA FILE______________________________________________________________
~faiths_and_powers/kits/multiclass/498_shammage/d5shmma.2da~

//RACIAL KIT AVAILABILITY_____________________________________________________________
~K_CM_H K_CM_HE K_CM_HO~

//UNUSABLE FLAGS AND KIT BASE CLASS_________________________________________________
//CLASSES: Mage = 1, Fighter = 2, Cleric=3, Thief = 4, Bard = 5
//         Paladin 6, Druid = 11, Ranger = 12, Sorcerer = 19
//         Monk = 20
~0x08000000 14~ // totemic

//HIGH LEVEL ABILITIES ABBREVIATION_________________________________________________
~CM0~

//TOB STARTING EQUIPMENT_____________________________________________________________
~CHAN09	* HELM07 BAG26 RING06 RING31 * BOOT01 AMUL20 BRAC10 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H27 STAF08~

//CHARACTER CREATION KIT DESCRIPTION________________________________________________
SAY @49801
SAY @49802
SAY @49803

//EE KIT EXTRAS______________________________________________________________________
// 
ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ THEN BEGIN
	LAF fl#add_kit_ee
		INT_VAR
			briefdesc = RESOLVE_STR_REF (@49803)
		STR_VAR
			kit_name = D5_SHAMAN_MAGE
			clswpbon = ~0 0 3~
			clsrcreq = ~1 0 1 0 0 0 1~
	END
END

//MULTICLASS SHAMAN FILES____________________________________________________________
//
COPY ~faiths_and_powers/kits/multiclass/498_shammage/d5shmma.2da~ ~override~
// APPEND ~d5shmma.2da~ ~CAST_INIT   AP_D5FPSPT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPSPT~
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END

//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 0
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 0
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 1
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 1
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5shmma~
	class 			= ~cleric_mage~
//	class 			= ~mystic~
	sphere_list		= ~vanilla_shaman_spheres~
  END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
	LAF fnp_spontaneous STR_VAR kit_clab = ~d5shmma~ learn_res = ~d5shmaz~ END
	LAF multiclass_shaman_item STR_VAR kit_clab = ~d5shmma~ learn_res = ~d5shmaz~ END
  END
 END
 
 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5shmma~ END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5shmma~ END
 END

 LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_MAGE~ 
		kit_clab = ~d5shmma~
		base_class = ~P~
 END

//GET KIT IDS_________________________________________________________________________
//
 OUTER_SET shammage_code = (0x4000 + %D5_SHAMAN_MAGE%)

//5E CASTING COMPAT___________________________________________________________________
// add 318 effects to exempt multisham from 5E casting
 APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
 COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
 BUT_ONLY
/*
 ACTION_FOR_EACH 5e_spl IN ~d5zz000~ ~d5zzini~ /*~d5zlots~*/ ~d5zltcl~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%5e_spl%.spl~) BEGIN
    COPY_EXISTING ~%5e_spl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = %shammage_code% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = EVAL ~%5e_spl%~ END
    BUT_ONLY
  END
 END
*/

END
//__________________________________________________________________________________



//__________________________________________________________________________________
//__________________________________________________________________________________
//
//									SHAMAN/MONK
//__________________________________________________________________________________
//__________________________________________________________________________________

DEFINE_ACTION_FUNCTION shaman_monk BEGIN

LAF check_kit_conflict END

ADD_KIT ~D5_SHAMAN_MONK~

//WEAPON PROFICIENCIES________________________________________________________________
//11             	                        T   S           F   Q             S S
//10             	L S                     W   C           L   U             W I
//9              	A M             B L S   O   I   W       A   A             O N
//8              	R A             A O H   H   M   A       I   R C   S       R G
//7              	G L           M S N O   A   I   R     H L   T R L H     2 D L 2                 E E E E E E E E E E E
//6              	E L       S   I T G R   N K T D H     A M   E O O O     H A E W E E E E E E E E X X X X X X X X X X X
//5              	S S   S B P   S A S T   D A A A A   S L O   R S N R   S A N W E X X X X X X X X T T T T T T T T T T T
//4              	W W   P L I   S R W S   E T R G M C P B R M S S G T D L N D E A T T T T T T T T R R R R R R R R R R R
//3              	O O B E U K A I D O W A D A W G M L E E N A T B B B A I D S A P R R R R R R R R A A A A A A A A A A A
//2              	R R O A N E X L S R O X S N A E E U A R I C A O O O R N E H P O A A A A A A A A 1 1 1 1 1 1 1 1 1 1 2
//1              	D D W R T D E E W D R E W A K R R B R D N E F W W W T G D I O N 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
~D5_SHAMAN_MONK     0 0 0 0 0 0 0 0~
~D5_SHAMAN_MONK     0 0 0 0 0 0 0 0 0 1 1 0 0 0 1 1 0 1 0 0 0 0 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0~

//MINIMUM KIT STATS_________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MONK         0   9   0   0   11  0~

//KIT STAT MODIFIERS________________________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MONK         0   0   0   0   0   0~

//REQUIREMENTS TO DUAL TO THIS KIT_________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MONK         0   17  0   0   17  0~

//REQUIREMENTS TO DUAL FROM THIS KIT________________________________________________
//                  	STR DEX CON INT WIS CHR
~D5_SHAMAN_MONK         0   15  0   0   15  0~

//ALIGNMENT RESTRICTIONS____________________________________________________________
//                  	LG LN LE NG TN NE CG CN CE
~D5_SHAMAN_MONK         0  0  0  1  1  1  0  0  0~

//DUAL CLASS OPTIONS________________________________________________________________
//                  	FT CL MA TH DR RA
~D5_SHAMAN_MONK         0  0  0  0  0  0~

//KIT ABILITIES 2DA FILE______________________________________________________________
~faiths_and_powers/kits/multiclass/495_shammonk/d5shmnk.2da~

//RACIAL KIT AVAILABILITY_____________________________________________________________
~K_CT_H~

//UNUSABLE FLAGS AND KIT BASE CLASS_________________________________________________
//CLASSES: Mage = 1, Fighter = 2, Cleric=3, Thief = 4, Bard = 5
//         Paladin 6, Druid = 11, Ranger = 12, Sorcerer = 19
//         Monk = 20
~0x08000000 15~ // totemic

//HIGH LEVEL ABILITIES ABBREVIATION_________________________________________________
~DR0~

//TOB STARTING EQUIPMENT_____________________________________________________________
~CHAN09	* HELM07 BAG26 RING06 RING31 * BOOT01 AMUL20 BRAC10 BELT06 AROW11,40 BULL03,40 BOLT06,40 POTN52,5 POTN04,2 POTN14,5 HAMM07 SW1H27 STAF08~

//CHARACTER CREATION KIT DESCRIPTION________________________________________________
SAY @49501
SAY @49502
SAY @49503

//EE KIT EXTRAS______________________________________________________________________
// 
ACTION_IF GAME_IS ~bgee bg2ee eet iwdee~ THEN BEGIN
	LAF fl#add_kit_ee
		INT_VAR
			briefdesc = RESOLVE_STR_REF (@49503)
		STR_VAR
			kit_name = D5_SHAMAN_MONK
			clswpbon = ~0 0 3~
			clsrcreq = ~1 0 1 0 0 0 1~
	END
END

//MULTICLASS SHAMAN FILES____________________________________________________________
//
COPY ~faiths_and_powers/kits/multiclass/495_shammonk/d5shmnk.2da~ ~override~
//  APPEND ~d5shmnk.2da~ ~CAST_INIT   AP_D5FPSPT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~AP_D5FPSPT~
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_notu.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_notu.spl~ ~override~
END
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5dil10.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 276 target = 1 parameter1 = 10 parameter2 = 0 timing = 9 END
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5dil04.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 276 target = 1 parameter1 = 4 parameter2 = 0 timing = 9 END
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5tshdi.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5shmdi~ END


//DEFINE SPHERE ACCESS______________________________________________________________
//
 LAF ~DEFINE_FNP_KIT_INFO~
  INT_VAR
	u_leather_armor 	= 1
	u_chain_armor 		= 0
	u_plate_armor 		= 0
	u_club_staff	 	= 1
	u_hammers	 		= 1
	u_maces 	 		= 0
	u_flails 			= 0
	u_axes 				= 0
	u_daggers 			= 1
	u_short_swords		= 0
	u_long_swords		= 0
	u_scimitars 		= 1
	u_katanas 			= 0
	u_bastard_swords 	= 0
	u_2hand_swords 		= 0
	u_halberds 			= 0
	u_spears 	 		= 0
	u_darts 			= 1
	u_slings	 		= 1
	u_bows 				= 0
	u_crossbows 		= 0
  STR_VAR
    clab_name 		= ~d5shmnk~
	class 			= ~cleric_thief~
//	class 			= ~mystic~
	sphere_list		= ~vanilla_shaman_spheres~
  END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
  WITH_TRA ~faiths_and_powers/language/%LANGUAGE%/fnp_spontaneous.tra~ BEGIN
	LAF fnp_spontaneous STR_VAR kit_clab = ~d5shmnk~ learn_res = ~d5shmkz~ END
	LAF multiclass_shaman_item STR_VAR kit_clab = ~d5shmnk~ learn_res = ~d5shmkz~ END
  END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~80~) BEGIN
	LAF apply_fnp_spheres_to_kit STR_VAR clab_name = ~d5shmnk~ END
 END

 ACTION_IF (MOD_IS_INSTALLED ~faiths_and_powers.tp2~ ~75~) BEGIN
	LAF apply_fnp_usability STR_VAR clab_name = ~d5shmnk~ END
	COPY_EXISTING ~weapprof.2da~ ~override~
	  COUNT_2DA_COLS cols
	  SET kit_cols = (cols - 1)
	  SET kit_col = (cols - 2)
	  SET_2DA_ENTRY 23 kit_col kit_cols 0
	BUT_ONLY
 END
 
 COPY_EXISTING ~LUMO0.2da~ ~override~
  COUNT_2DA_ROWS 10 rows
  FOR (row = 0; row < rows; ++row) BEGIN
	READ_2DA_ENTRY row 1 10 monk_ability
	PATCH_IF !(~%monk_ability%~ STRING_EQUAL_CASE ~*~) BEGIN
	  SNPRINT 3 hla_type ~%monk_ability%~
	  PATCH_IF (~%hla_type%~ STRING_EQUAL_CASE ~GA_~) || (~%hla_type%~ STRING_EQUAL_CASE ~AP_~) BEGIN
		READ_2DA_ENTRY row 2 10 monk_icon
		READ_2DA_ENTRY row 3 10 monk_strref
		READ_2DA_ENTRY row 4 10 monk_min_lev
		READ_2DA_ENTRY row 5 10 monk_max_level
		READ_2DA_ENTRY row 6 10 monk_num_allowed
		READ_2DA_ENTRY row 7 10 monk_prerequisite
		READ_2DA_ENTRY row 8 10 monk_excluded_by
		READ_2DA_ENTRY row 9 10 monk_alignment_restrict
		INNER_ACTION BEGIN
		  LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MONK~ ability = EVAL ~%monk_ability%~ icon = EVAL ~%monk_icon%~ strref = EVAL ~%monk_strref%~ min_lev = EVAL ~%monk_min_lev%~ max_level = EVAL ~%monk_max_level%~ num_allowed = EVAL ~%monk_num_allowed%~ prerequisite = EVAL ~%monk_prerequisite%~ excluded_by = EVAL ~%monk_excluded_by%~ alignment_restrict = EVAL ~%monk_alignment_restrict%~ END
		END
	  END
	END
  END
 IF_EXISTS BUT_ONLY

 LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_MONK~ 
		kit_clab = ~d5shmnk~
		base_class = ~P~
 END
 LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_MONK~ 
		kit_clab = ~QDMONK_C~
		base_class = ~T~
 END

//GET KIT IDS_________________________________________________________________________
//
 OUTER_SET shammonk_code = (0x4000 + %D5_SHAMAN_MONK%)

//5E CASTING COMPAT___________________________________________________________________
// add 318 effects to exempt multisham from 5E casting
 APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
 COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
 BUT_ONLY
 ACTION_FOR_EACH 5e_spl IN ~d5zz000~ ~d5zzini~ /*~d5zlots~*/ ~d5zltcl~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%5e_spl%.spl~) BEGIN
    COPY_EXISTING ~%5e_spl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 318 target = 1 parameter1 = %shammonk_code% parameter2 = %kit_is_row% timing = 0 duration = 1 STR_VAR resource = EVAL ~%5e_spl%~ END
    BUT_ONLY
  END
 END

END
//__________________________________________________________________________________


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							MULTICLASS SHAMAN SYSTEM
//__________________________________________________________________________________
//__________________________________________________________________________________

// use this if no sphere system; if spheres, use regular fnp_spontaneous

DEFINE_ACTION_FUNCTION multiclass_shaman_system BEGIN

//get kit identifiers________________________________________________________________
//
OUTER_SET barb_shaman_code = IDS_OF_SYMBOL (~kit~ ~D5_BARB_SHAMAN~)
OUTER_SET ranger_shaman_code = IDS_OF_SYMBOL (~kit~ ~D5_SHAMAN_RANGER~)
OUTER_SET shaman_thief_code = IDS_OF_SYMBOL (~kit~ ~D5_SHAMAN_THIEF~)
OUTER_SET shaman_mage_code = IDS_OF_SYMBOL (~kit~ ~D5_SHAMAN_MAGE~)
OUTER_SET shaman_monk_code = IDS_OF_SYMBOL (~kit~ ~D5_SHAMAN_MONK~)

APPEND ~splprot.2da~ ~D5_KIT_IS%TAB%152%TAB%-1%TAB%1~ UNLESS ~D5_KIT_IS~
COPY_EXISTING ~splprot.2da~ ~override~
	COUNT_2DA_COLS cols
	READ_2DA_ENTRIES_NOW rows cols
	FOR (row = 1; row < rows; ++row) BEGIN
	  READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	  PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_KIT_IS~ BEGIN
	    SET kit_is_row = %row%
	  END
	END
BUT_ONLY


//___________________________________________________________________________________
//
<<<<<<<< d5/d5sham.2da
ABILITY     ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
>>>>>>>>
COPY ~d5/d5sham.2da~ ~override/d5sham.2da~


//add spell slot stat checks to SPLPROT______________________________________________
//
APPEND ~splprot.2da~ ~D5_DIV_1_7%TAB%134%TAB%-1%TAB%7~ UNLESS ~D5_DIV_1_7~
APPEND ~splprot.2da~ ~D5_FATIGUE_IS%TAB%30%TAB%-1%TAB%1~ UNLESS ~D5_FATIGUE_IS~

COPY_EXISTING ~splprot.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW rows cols
  FOR (row = 1; row < rows; ++row) BEGIN
	READ_2DA_ENTRY_FORMER rows row 0 ~stat~
	PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_DIV_1_7~ BEGIN
	  SET fake_sham_slots_1_7 = %row%
	END
	PATCH_IF ~%stat%~ STRING_EQUAL_CASE ~D5_FATIGUE_IS~ BEGIN
	  SET fatigue_value = %row%
	END
  END
BUT_ONLY


//remove all cleric spell slots_______________________________________________________
//
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d50cslt.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 62 target = 1 parameter1 = (0 - 1) parameter2 = 127 timing = 9 END
BUT_ONLY

APPEND ~d5sham.2da~ ~NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
NOSLOTS     AP_D50CSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** 
~


//create advance copies of some spells________________________________________________
//
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5sh206.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5sh172.spl~

COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot1a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot1b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot1c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot1d.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot2a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot2b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot2c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot2d.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot3a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot3b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot3c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot3d.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot4a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot4b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot4c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot4d.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot5a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot5b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot5c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot5d.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot6a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot6b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot6c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot6d.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot7a.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot7b.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot7c.spl~
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shot7d.spl~

COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot1a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot1b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot1c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 4) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot1d~ END
//COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz2.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot2a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot2b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot2c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 8) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot2d~ END
//COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz3.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot3a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot3b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot3c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 12) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot3d~ END
//COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz4.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot4a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot4b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot4c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 16) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot4d~ END
//COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz5.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot5a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot5b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot5c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 20) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot5d~ END
//COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz6.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot6a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot6b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot6c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 24) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot6d~ END
//COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shplz7.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (1 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot7a~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (2 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot7b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (4 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot7c~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = (8 << 28) parameter2 = %fake_sham_slots_1_7% timing = 1 STR_VAR resource = ~d5shot7d~ END


//assign stats for spell slots to each spell level____________________________________
//
// divine level 1 = 	134 << 4
// divine level 2 = 	134 << 8
// divine level 3 = 	134 << 12
// divine level 4 = 	134 << 16
// divine level 5 = 	134 << 20
// divine level 6 = 	134 << 24
// divine level 7 = 	134 << 28

ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm1a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm1%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 4) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm1%let%~ END
  END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm2a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm2%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 8) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm2%let%~ END
  END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm3a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm3%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 12) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm3%let%~ END
  END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm4a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm4%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 16) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm4%let%~ END
  END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm5a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm5%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 20) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm5%let%~ END
  END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm6a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm6%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 24) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm6%let%~ END
  END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm7a.spl~ BEGIN
  ACTION_FOR_EACH let IN ~a~ /*~b~ ~c~ ~d~ ~e~ ~f~ ~g~ ~h~ ~i~ ~j~ ~k~ ~l~ ~m~ ~n~ ~o~ ~p~ ~q~ ~r~ ~s~ ~t~*/ BEGIN
	COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm7%let%.spl~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = (1 << 28) parameter2 = (134 + (0x10000 * 1)) timing = 9 END
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~d5shm7%let%~ END
  END
END

ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-1.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-1.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 4) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-2.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-2.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 8) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-3.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-3.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 12) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-4.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-4.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 16) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-5.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-5.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 20) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-6.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-6.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 24) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shm-7.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shm-7.spl~
   LPF ADD_SPELL_EFFECT INT_VAR opcode = 233 target = 1 parameter1 = ((0 - 1) << 28) parameter2 = (134 + (0x10000 * 1)) timing = 1 END
END

//quickly address wondrous recall_____________________________________________________
//
ACTION_IF (MOD_IS_INSTALLED ~d5_random_tweaks.tp2~ ~1611~) BEGIN
  COPY_EXISTING ~sppr611.spl~ ~override~
    LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR match_resource = ~d5shm-1~ END
    LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR match_resource = ~d5shm-2~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-1~ END
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-2~ END
  BUT_ONLY
  ACTION_IF (FILE_EXISTS_IN_GAME ~dvsrv4here.mrk~) BEGIN
    ACTION_IF (FILE_EXISTS_IN_GAME ~potn43.spl~) BEGIN
//	  COPY_EXISTING ~sppr611.spl~ ~override/potn43.spl~
	  COPY_EXISTING ~potn43.spl~ ~override~
        LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR match_resource = ~d5shm-1~ END
        LPF DELETE_EFFECT INT_VAR match_opcode = 321 STR_VAR match_resource = ~d5shm-2~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-1~ END
		LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-2~ END
	  IF_EXISTS BUT_ONLY
    END
  END
END


INCLUDE ~%MOD_FOLDER%/lib/semi_spontaneous.tpa~

COPY_EXISTING ~mxsplshm.2da~ ~override~
  LPF divine_casting_slots STR_VAR table_spl = ~d5prslt~ END
BUT_ONLY

APPEND ~d5sham.2da~  ~SPLSLOTS    AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  AP_D5PRSLT  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~ UNLESS ~SPLSLOTS~


ACTION_IF !(FILE_EXISTS_IN_GAME ~d5_shmkn.2da~) BEGIN
  COPY_EXISTING ~splshmkn.2da~ ~override/d5_shmkn.2da~
END


/*
//set up spell learn UI screens_______________________________________________________
//
//INCLUDE ~faiths_and_powers/lib/sequencer_menu_d5.tpa~
INCLUDE ~faiths_and_powers/lib/sequencer_menu.tpa~

LAF CREATE_SEQUENCER_MENU 
  INT_VAR 
	name = RESOLVE_STR_REF (~Spell Selection~)
	tip = RESOLVE_STR_REF (~Spell Selection~)
	desc = RESOLVE_STR_REF (~This ability allows you to learn new spells~)
	class = 2
	maxlevel = 7
	exclude = 0x80000000 
  STR_VAR 
	spelltable = ~d5_shmkn~
	resref = ~d5shamb~
	icon = ~spcl919b~
	title = ~Spell Selection~
	label = ~Select a spell to learn~
	subspell = ~H~
END
*/


//clone divine spells________________________________________________________________
//
//... to innates, with added 146 casting subspells with 233 reducing level 1-9 stats (see below)
//... and to blank cleric spells w/ 146/148 casting innates
//... and to blank mage spells w/ nuthin'

<<<<<<<< d5/d5shclon.2da
2DA V1.0 
SPLRES
		206		LEARN		EFF		INNATE	DISPLAY
>>>>>>>> 

COPY ~d5/d5shclon.2da~ ~override/d5shclon.2da~ 

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5msham.2da~) BEGIN
<<<<<<<<  d5/d5msham.2da
2DA      V1.0
0
				SHAMAN
>>>>>>>>
 COPY ~d5/d5msham.2da~ ~override/d5msham.2da~

 COPY_EXISTING_REGEXP GLOB ~^SPPR[1-7]\(0[1-9]\|[1-4][0-9]\|50\)\.spl$~ ~override~
  READ_SHORT 0x1c spell_type
  READ_BYTE 0x21 ok_druid
  PATCH_IF (spell_type = 2) && ((%ok_druid% BOR 0b01111111) = 0b01111111) BEGIN
	LPF NAME_NUM_OF_SPELL_RES STR_VAR spell_res = EVAL ~%SOURCE_RES%~ RET spell_name END
	PATCH_IF (FILE_CONTAINS_EVALUATED (~spell.ids~ ~[ %TAB%]%spell_name%[ %TAB%%LNL%%MNL%%WNL%]~)) && !(FILE_CONTAINS_EVALUATED (~hidespl.2da~ ~%SOURCE_RES%~)) BEGIN
	  INNER_ACTION BEGIN
//		APPEND ~d5msham.2da~ ~%SOURCE_RES%	: %spell_name%~
		APPEND ~d5msham.2da~ ~Shaman	%SOURCE_RES%	3~
	  END
	END
  END
 BUT_ONLY

// INCLUDE ~faiths_and_powers/lib/sequencer_menu_d5.tpa~
 INCLUDE ~faiths_and_powers/lib/sequencer_menu.tpa~

 LAF CREATE_SEQUENCER_MENU 
  INT_VAR 
	name = RESOLVE_STR_REF (~Spell Selection~)
	tip = RESOLVE_STR_REF (~Spell Selection~)
	desc = RESOLVE_STR_REF (~This ability allows you to learn new spells~)
//	class = 2
//	maxlevel = 7
//	column = 1
  STR_VAR 
	spelltable = ~d5_shmkn~
	spelllist = ~d5msham~
	resref = ~d5msham~
	icon = ~spcl919b~
	title = ~Spell Selection~
	label = ~Select a spell to learn~
	subspell = ~H~
 END
END

COPY_EXISTING ~d5msham.2da~ ~override/d5mshamX.2da~

OUTER_SET sham_spell_ind = 1

COPY_EXISTING ~d5msham.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW ~r2en_shlist~ cols
  FOR (row = 0; row < r2en_shlist; ++row) BEGIN
	READ_2DA_ENTRY_FORMER ~r2en_shlist~ row 1 lstspl
//	READ_2DA_ENTRY_FORMER ~r2en_shlist~ row 2 bool
	PATCH_IF (FILE_EXISTS_IN_GAME ~%lstspl%.spl~) BEGIN
	  INNER_ACTION BEGIN
		COPY_EXISTING ~%lstspl%.spl~ ~override~
		  PATCH_IF (~%SOURCE_RES%~ STRING_MATCHES_REGEXP ~[SsDd][Pp5][PpFfMm][RrPpWwLlNnSsBb85][1-7][0-5][0-9]~ = 0) BEGIN
			TEXT_SPRINT the_spell ~%SOURCE_RES%~
//			PATCH_IF (FILE_EXISTS_IN_GAME ~%SOURCE_RES%H.SPL~) BEGIN
			  SET string_length = (STRING_LENGTH ~%the_spell%~)
			  PATCH_IF (%string_length% < 8) BEGIN
				INNER_PATCH_SAVE spell_to_cast ~%the_spell%~ BEGIN
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm][Pp]~ ~sppr~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm][Ww]~ ~spwi~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm][Ll]~ ~spcl~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm][Nn]~ ~spin~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm][Ss]~ ~spsd~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm][Bb]~ ~b_c~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm]8~ ~b_pr~
				  REPLACE_TEXTUALLY ~^[Dd]5[PpFfMm]5~ ~d5fnp~
				END
			  END ELSE BEGIN
				TEXT_SPRINT spell_to_cast ~%the_spell%~
			  END
			  TEXT_SPRINT 206_spell ~d5c6%sham_spell_ind%~
			  TEXT_SPRINT learn_spell ~%the_spell%H~
			  TEXT_SPRINT spell_eff ~D5CV%sham_spell_ind%~
			  TEXT_SPRINT innate_spell ~d5c4%sham_spell_ind%~
			  PATCH_IF !(FILE_CONTAINS_EVALUATED (~d5shclon.2da~ ~%spell_to_cast%~)) BEGIN
				INNER_ACTION BEGIN
				  APPEND ~d5shclon.2da~ ~%the_spell%	%206_spell%	%learn_spell%	%spell_eff%	%innate_spell%	%spell_to_cast% ~
				END
			  END
//			END
			SET ++sham_spell_ind
		  END
		BUT_ONLY
	  END
	END
  END
BUT_ONLY

COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shfre.spl~
  PATCH_FOR_EACH lv IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ BEGIN
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = EVAL ~sppr%lv%50~ END
  END
	
OUTER_SET ++sham_spell_ind

ACTION_FOR_EACH lvl IN ~1~ ~2~ ~3~ ~4~ ~5~ ~6~ ~7~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~sppr%lvl%50.spl~) BEGIN
	COPY_EXISTING ~sppr%lvl%50.spl~ ~override~
	  TEXT_SPRINT spell_to_cast ~%SOURCE_RES%~
	  TEXT_SPRINT 206_spell ~d5c6%sham_spell_ind%~
	  TEXT_SPRINT learn_spell ~d5cx%sham_spell_ind%~
	  TEXT_SPRINT spell_eff ~D5CV%sham_spell_ind%~
	  TEXT_SPRINT innate_spell ~d5c4%sham_spell_ind%~
	  PATCH_IF !(FILE_CONTAINS_EVALUATED (~d5shclon.2da~ ~%spell_to_cast%~)) BEGIN
		INNER_ACTION BEGIN
		  APPEND ~d5shclon.2da~ ~%spell_to_cast%	%206_spell%	%learn_spell%	%spell_eff%	%innate_spell%	%spell_to_cast% ~
		  COPY_EXISTING ~d5shfre.spl~ ~override~
		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~%206_spell%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%206_spell%~ END
		  BUT_ONLY
		END
	  END
	  SET ++sham_spell_ind
	BUT_ONLY
  END
END

// do this in the initialization spell instead...?
//APPEND ~d5sham.2da~ ~FREESPLS    AP_D5SHFRE  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~


COPY_EXISTING ~d5shclon.2da~ ~override~
  COUNT_2DA_COLS cols
  READ_2DA_ENTRIES_NOW ~r2en_shclon~ cols
  FOR (row = 0; row < r2en_shclon; ++row) BEGIN
	READ_2DA_ENTRY_FORMER ~r2en_shclon~ row 0 book_spl
	READ_2DA_ENTRY_FORMER ~r2en_shclon~ row 1 206_spl
	READ_2DA_ENTRY_FORMER ~r2en_shclon~ row 2 learn_spl
	READ_2DA_ENTRY_FORMER ~r2en_shclon~ row 3 spl_eff
	READ_2DA_ENTRY_FORMER ~r2en_shclon~ row 4 innate_spl
	READ_2DA_ENTRY_FORMER ~r2en_shclon~ row 5 real_spl
	INNER_ACTION BEGIN
	  COPY_EXISTING ~%book_spl%.spl~ ~override~
		READ_LONG 0x34 spell_level
//		READ_STRREF NAME1 spell_name
//		READ_STRREF UNIDENTIFIED_DESC spell_description
		READ_ASCII 0x3a spell_icon
	  BUT_ONLY
// make innates that cast the original
//	  ACTION_IF NOT FILE_EXISTS_IN_GAME ~%innate_spl%.spl~ BEGIN
		COPY_EXISTING ~%book_spl%.spl~ ~override/%innate_spl%.spl~
		  WRITE_SHORT 0x1c 4
		  WRITE_BYTE 0x27 0									//	no sectype for the innates
		  LPF ALTER_SPELL_HEADER INT_VAR location = 2 END
		  READ_LONG 0x64 abil_offset
		  READ_SHORT 0x68 abil_number
		  READ_BYTE (%abil_offset% + 0x0c) abil_target					
		  READ_SHORT (%abil_offset% + 0x0e) abil_range
		  READ_LONG 0x6a eff_offset
		  WHILE (%abil_number% > 0) BEGIN
			SET abil_number = (%abil_number% - 1)
			WRITE_SHORT (%abil_offset% + 0x26 + (0x28 * %abil_number%)) 1
		  END
		  READ_BYTE (%eff_offset% + 0x02) eff_target
		  LPF DELETE_EFFECT END
		  PATCH_IF (%abil_target% = 4) BEGIN
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 148 target = 1 power = %spell_level% parameter1 = 0 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~%real_spl%~ END
			PATCH_IF (%abil_range% < 35) BEGIN
			  PATCH_IF (%abil_range% > 4) BEGIN
				LPF ALTER_SPELL_HEADER INT_VAR range = (%abil_range% - 3) END
			  END
			  PATCH_IF (%abil_range% < 5) BEGIN
			 	LPF ALTER_SPELL_HEADER INT_VAR target = 5 END	// might need to carve out exceptions, e.g. burning hands
			  END
			END
		  END
		  ELSE BEGIN
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 2 power = %spell_level% parameter2 = 1 timing = 9 STR_VAR resource = EVAL ~%real_spl%~ END
		  END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = EVAL ~d5shm-%spell_level%~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5sh172~ END
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5shplz~ END
// make .EFFs adding the innate spell
		CREATE EFF ~%spl_eff%~
			WRITE_LONG 0x10 171
			WRITE_LONG 0x14 1
			WRITE_LONG 0x24 0
			WRITE_LONG 0x28 1
			WRITE_SHORT 0x2c 100
			WRITE_EVALUATED_ASCII 0x30 ~%innate_spl%~ #8
			WRITE_LONG 0x90 1
			WRITE_EVALUATED_ASCII 0x94 ~%spl_eff%~ #8
// make 206 spells preventing the .EFF
		COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/%206_spl%.spl~
			WRITE_SHORT 0x1c 4
		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
// add 206 spells to CLAB spell
		COPY_EXISTING ~d5sh206.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 9 STR_VAR resource = EVAL ~%206_spl%~ END
// make learn spells canceling the 206
		COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/%learn_spl%.spl~
			WRITE_EVALUATED_ASCII 0x3a ~%spell_icon%~ #8
		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = EVAL ~%206_spl%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%206_spl%~ END
		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = EVAL ~%real_spl%~ END
//		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 309 target = 1 parameter1 = 1 parameter2 = 0 timing = 9 STR_VAR resource = EVAL ~%real_spl%~ END
		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = ~d5sh172~ END
		  	LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter1 = 0 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5shplz~ END
// make copy of learn spell for kjeron's UI system (eventually, just rename the learn spell to this name)
//		COPY_EXISTING ~%learn_spl%.spl~ ~override/%spell_res%M.spl~
// add 172 to d5shplz#
		COPY_EXISTING ~d5sh172.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR insert_point = 0 opcode = 172 target = 1 timing = 9 STR_VAR resource = EVAL ~%innate_spl%~ END
// generate slot#x spells
		COPY_EXISTING ~d5shot%spell_level%a.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
		COPY_EXISTING ~d5shot%spell_level%b.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
		COPY_EXISTING ~d5shot%spell_level%c.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
		COPY_EXISTING ~d5shot%spell_level%d.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = EVAL ~%spl_eff%~ END
/*
		COPY_EXISTING ~%book_spl%h.spl~ ~override~
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = barb_shaman_code parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_spl%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = ranger_shaman_code parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_spl%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = shaman_thief_code parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_spl%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = shaman_mage_code parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_spl%~ END
			LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = shaman_monk_code parameter2 = %kit_is_row% timing = 1 STR_VAR resource = EVAL ~%learn_spl%~ END
		IF_EXISTS
*/
//	  END
	END
  END
BUT_ONLY


/* don't think this is used...
//remove known spells right after chargen_____________________________________________
//
APPEND ~d5sham.2da~ ~NO_WSPLS    AP_D50WSPL  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
*/                                

//apply EFF protections_______________________________________________________________
//
APPEND ~d5sham.2da~ ~NO_SPLS     AP_D5SH206 ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~


//daily spell slot refresh____________________________________________________________
//
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shotz.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shots~ END

//APPEND ~d5sham.2da~ ~SPLSLOTS    AP_D5SHOTZ  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~

CREATE EFF ~d5shots~
  WRITE_LONG 0x10 232
  WRITE_LONG 0x14 1
  WRITE_LONG 0x1c 0
  WRITE_LONG 0x20 20
  WRITE_LONG 0x24 9
  WRITE_SHORT 0x2c 100
  WRITE_ASCII 0x30 ~d5shlot~ #8
  WRITE_LONG 0x48 102

COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shlot.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = 0 parameter2 = %fatigue_value% timing = 1 STR_VAR resource = ~d5shfrsh~ END


// spell to refresh spell slots_______________________________________________________
ACTION_IF NOT FILE_EXISTS_IN_GAME ~d5shfrsh.spl~ BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shfrsh.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 93 target = 1 parameter1 = 1 parameter2 = 1 timing = 1 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-1~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-2~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-3~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-4~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-5~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-6~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shm-7~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 duration = 0 STR_VAR resource = ~d5sh172~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 4 duration = 1 STR_VAR resource = ~d5shplz~ END
END


//handle universal spells_____________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN

// ***** use the d5_spontaneous function instead of this
// and ALTER_EFFECT d5shnit.spl to give multisham .itm instead of 

 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5xpuni.spl~

 COPY_EXISTING ~d5spsph.2da~ ~override~
  READ_2DA_ENTRIES_NOW rows 4
  FOR (row = 0; row < 20; ++row) BEGIN
	READ_2DA_ENTRY_FORMER rows row 0 spl_name
	READ_2DA_ENTRY_FORMER rows row 3 sph_des
	PATCH_IF (~%sph_des%~ STRING_EQUAL_CASE ~Universal~) BEGIN
	  PATCH_IF (FILE_CONTAINS_EVALUATED (~spell.ids~ ~[ %TAB%]%spl_name%[ %TAB%%LNL%%MNL%%WNL%]~)) BEGIN
		LPF RES_NUM_OF_SPELL_NAME STR_VAR spell_name = EVAL ~%spl_name%~ RET spell_res spell_num END
		TEXT_SPRINT the_spell ~%spell_res%~
	  END
	  ELSE BEGIN
		TEXT_SPRINT the_spell ~%spl%~
	  END  
	  PATCH_IF (FILE_EXISTS_IN_GAME ~%the_spell%.spl~) BEGIN
		INNER_ACTION BEGIN
			COPY_EXISTING ~d5shclon.2da~ ~override~
			  COUNT_2DA_COLS cols
			  READ_2DA_ENTRIES_NOW ~r2en_shclon~ cols
			  FOR (ind = 0; ind < r2en_shclon; ++ind) BEGIN
				READ_2DA_ENTRY_FORMER ~r2en_shclon~ ind 0 book_spl_res
				READ_2DA_ENTRY_FORMER ~r2en_shclon~ ind 2 learn_spl_res
				PATCH_IF (~%book_spl_res%~ STRING_EQUAL_CASE ~%the_spell%~) BEGIN
				  PATCH_PRINT ~%spl_name%~
				  INNER_PATCH_SAVE removal_eff ~%book_spl_res%~ BEGIN
					REPLACE_TEXTUALLY ~^[Ss][Pp][Pp][Rr]~ ~D5XP~
				  END
				  TEXT_SPRINT $universal_spontaneous(~%book_spl_res%~ ~%learn_spl_res%~) ~%removal_eff%~
				END
			  END
			BUT_ONLY
		END
	  END
	END
  END
 BUT_ONLY

 ACTION_PHP_EACH universal_spontaneous AS unispl => remeff BEGIN
  OUTER_SPRINT lrnspl ~%unispl_1%~
//  PRINT ~%unispl% : %lrnspl% : %remeff%~
  ACTION_IF (FILE_EXISTS_IN_GAME ~%lrnspl%.spl~) BEGIN
	COPY_EXISTING ~%lrnspl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%remeff%~ END
	BUT_ONLY
	CREATE EFF ~%remeff%~
	  WRITE_LONG 0x10 172
	  WRITE_LONG 0x14 1
	  WRITE_LONG 0x24 9
	  WRITE_SHORT 0x2c 100
	  WRITE_EVALUATED_ASCII 0x30 ~%unispl%~ #8
	  WRITE_LONG 0x90 1
	  WRITE_EVALUATED_ASCII 0x94 ~%remeff%~ #8
	COPY_EXISTING ~d5xpuni.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 4 duration = 1 STR_VAR resource = EVAL ~%remeff%~ END
	BUT_ONLY
  END
 END

 APPEND ~d5sham.2da~ ~UNIVERSAL   AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI  AP_D5XPUNI ~

END


//handle all spells if no spheres_____________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN

 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5xpall.spl~

 COPY_EXISTING_REGEXP GLOB ~^SPPR[1-7]\(0[1-9]\|[1-4][0-9]\|50\)\.spl$~ ~override~
  READ_BYTE 0x21 exclusion
  PATCH_IF (%exclusion% BOR 0b01111111 = 0b01111111) || (%exclusion% BOR 0b10111111 = 0b10111111) BEGIN
	LPF NAME_NUM_OF_SPELL_RES STR_VAR spell_res = EVAL ~%SOURCE_RES%~ RET spell_name END
	PATCH_IF (FILE_CONTAINS_EVALUATED (~spell.ids~ ~%spell_name%[ %TAB%%LNL%%MNL%%WNL%]~)) && !(FILE_CONTAINS_EVALUATED (~hidespl.2da~ ~%SOURCE_RES%~)) BEGIN
	  TEXT_SPRINT the_spell ~%SOURCE_RES%~
	  INNER_PATCH_SAVE removal_eff ~%the_spell%~ BEGIN
		REPLACE_TEXTUALLY ~^[Ss][Pp][Pp][Rr]~ ~D5XP~
	  END
	  INNER_ACTION BEGIN
		CREATE EFF ~%removal_eff%~
		  WRITE_LONG 0x10 172
		  WRITE_LONG 0x14 1
		  WRITE_LONG 0x24 9
		  WRITE_SHORT 0x2c 100
		  WRITE_EVALUATED_ASCII 0x30 ~%the_spell%~ #8
		  WRITE_LONG 0x90 1
		  WRITE_EVALUATED_ASCII 0x94 ~%removal_eff%~ #8
		COPY_EXISTING ~d5xpall.spl~ ~override~
		  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 4 duration = 1 STR_VAR resource = EVAL ~%removal_eff%~ END
		BUT_ONLY
		COPY_EXISTING ~d5shclon.2da~ ~override~
		  COUNT_2DA_COLS cols
		  READ_2DA_ENTRIES_NOW ~r2en_shclon~ cols
		  FOR (ind = 0; ind < r2en_shclon; ++ind) BEGIN
			READ_2DA_ENTRY_FORMER ~r2en_shclon~ ind 0 book_spl_res
			READ_2DA_ENTRY_FORMER ~r2en_shclon~ ind 2 learn_spl_res
			PATCH_IF (~%book_spl_res%~ STRING_EQUAL_CASE ~%the_spell%~) BEGIN
			  INNER_PATCH_SAVE removal_eff ~%book_spl_res%~ BEGIN
				REPLACE_TEXTUALLY ~^[Ss][Pp][Pp][Rr]~ ~D5XP~
			  END
			  TEXT_SPRINT $all_spontaneous(~%book_spl_res%~ ~%learn_spl_res%~) ~%removal_eff%~
			END
		  END
		BUT_ONLY
	  END
	END
  END
 BUT_ONLY

 ACTION_PHP_EACH all_spontaneous AS allspl => remeff BEGIN
  OUTER_SPRINT lrnspl ~%allspl_1%~
  ACTION_IF (FILE_EXISTS_IN_GAME ~%lrnspl%.spl~) BEGIN
	COPY_EXISTING ~%lrnspl%.spl~ ~override~
	  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = EVAL ~%remeff%~ END
	BUT_ONLY
  END
 END

 APPEND ~d5sham.2da~ ~NO_SPELLS   AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL  AP_D5XPALL ~

END


//don't need initial memorizer________________________________________________________
//
ACTION_IF (FILE_EXISTS_IN_GAME ~d5__spheres.d5~) BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5spmxm.spl~
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = (0 - 1) timing = 9 STR_VAR resource = ~d5spmem~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 4 duration = 1 STR_VAR resource = ~d5spm3m~ END

 APPEND ~d5sham.2da~ ~NO_SLEEP     AP_D5SPMXM  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~
END


//make HLA tables_____________________________________________________________________
//
LAF action_remove_hla STR_VAR kit_name = ~D5_BARB_SHAMAN~ remove_ability = ~GA_SPPR726~ END
LAF action_add_hla STR_VAR kit_name = ~D5_BARB_SHAMAN~ ability = ~GA_SPPR751~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_BARB_SHAMAN~ ability = ~GA_SPCL940~ num_allowed = ~22~ END
LAF action_add_hla STR_VAR kit_name = ~D5_BARB_SHAMAN~ ability = ~GA_SPCL941~ num_allowed = ~1~ prerequisite = ~GA_SPCL940~ END
LAF action_remove_hla STR_VAR kit_name = ~D5_SHAMAN_RANGER~ remove_ability = ~GA_SPPR726~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_RANGER~ ability = ~GA_SPPR751~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_RANGER~ ability = ~GA_SPCL940~ num_allowed = ~22~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_RANGER~ ability = ~GA_SPCL941~ num_allowed = ~1~ prerequisite = ~GA_SPCL940~ END
LAF action_remove_hla STR_VAR kit_name = ~D5_SHAMAN_THIEF~ remove_ability = ~GA_SPPR726~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_THIEF~ ability = ~GA_SPPR751~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_THIEF~ ability = ~GA_SPCL940~ num_allowed = ~22~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_THIEF~ ability = ~GA_SPCL941~ num_allowed = ~1~ prerequisite = ~GA_SPCL940~ END
LAF action_remove_hla STR_VAR kit_name = ~D5_SHAMAN_MAGE~ remove_ability = ~GA_SPPR726~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MAGE~ ability = ~GA_SPPR751~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MAGE~ ability = ~GA_SPCL940~ num_allowed = ~22~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MAGE~ ability = ~GA_SPCL941~ num_allowed = ~1~ prerequisite = ~GA_SPCL940~ END
LAF action_remove_hla STR_VAR kit_name = ~D5_SHAMAN_MONK~ remove_ability = ~GA_SPPR726~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MONK~ ability = ~GA_SPPR751~ num_allowed = ~1~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MONK~ ability = ~GA_SPCL940~ num_allowed = ~22~ END
LAF action_add_hla STR_VAR kit_name = ~D5_SHAMAN_MONK~ ability = ~GA_SPCL941~ num_allowed = ~1~ prerequisite = ~GA_SPCL940~ END
// ***** need to further fix the shammonk table


//disable quickspell buttons and scroll learning______________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shmnq.spl~) BEGIN
  COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shmnq.spl~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 144 target = 1 parameter2 = 3 timing = 9 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 144 target = 1 parameter2 = 4 timing = 9 END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 144 target = 1 parameter2 = 5 timing = 9 END
END

APPEND ~d5sham.2da~ ~NO_QUICK    AP_D5SHMNQ  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~


//recreate shamanic dance_____________________________________________________________
//
// leave out the movement check... just stop movement and reenable it upon canceling dance
// patch to 50% movement if the 'improved shamanic dance' mod is installed

COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdn.bam~ ~override~		//	dance icon
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdn.spl~ ~override~		//	dance ability
  SAY NAME1 @49921// Shamanic Dance
  SAY UNIDENTIFIED_DESC @49921 
  LPF ALTER_SPELL_HEADER INT_VAR location = 4 STR_VAR icon = ~d5shmdn~ END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5nshdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
  PATCH_IF (MOD_IS_INSTALLED ~A7#ImprovedShamanicDance.tp2~ ~0~) BEGIN
	LPF ALTER_EFFECT INT_VAR silent = 1 match_opcode = 176 match_parameter1 = 0 parameter1 = 50 parameter2 = 2 END
  END
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdnb.eff~ ~override~		//	232 eff triggered by song
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdnb.spl~ ~override~		//	aura triggered by 232 eff
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5nshdn.bam~ ~override~		//	stop dance icon
/*
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5nshdn.spl~				//	stop dance abil
  SAY NAME1 @49923 // Stop Shamanic Dance
  SAY UNIDENTIFIED_DESC @49923 
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5nshdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5nshdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
*/
CREATE EFF ~d5shmdn~
	WRITE_LONG 0x10 171
	WRITE_LONG 0x14 1
	WRITE_LONG 0x24 9
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5shmdn~ #8
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5SHMDN~ #8


//recreate detect illusions__________________________________________________________
//
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdi.bam~ ~override~		//	detect icon
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdi.spl~ ~override~		//	dance ability
  SAY NAME1 @49924 // Detect Illusions
  SAY UNIDENTIFIED_DESC @49924 
  LPF ALTER_SPELL_HEADER INT_VAR location = 4 STR_VAR icon = ~d5shmdi~ END
//  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5nshdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdi~ END
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdib.eff~ ~override~							//	232 eff triggered by song
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shmdib.spl~ ~override~							//	aura triggered by 232 eff
COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5nshdi.bam~ ~override~		//	stop detect icon
/*
COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5nshdi.spl~				//	stop detect abil
  SAY NAME1 @49926 // Stop detecting illusions
  SAY UNIDENTIFIED_DESC @49926 
  LPF ALTER_SPELL_HEADER INT_VAR target = 7 STR_VAR icon = ~d5nshdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 321 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5nshdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 171 target = 1 timing = 9 STR_VAR resource = ~d5shmdi~ END
*/
CREATE EFF ~d5shmdi~
	WRITE_LONG 0x10 171
	WRITE_LONG 0x14 1
	WRITE_LONG 0x24 9
	WRITE_LONG 0x28 0
	WRITE_SHORT 0x2c 100
	WRITE_EVALUATED_ASCII 0x30 ~d5shmdi~ #8
	WRITE_LONG 0x90 1
	WRITE_EVALUATED_ASCII 0x94 ~D5SHMDI~ #8


//learn spell item & initialize_______________________________________________________
//
ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shamb.itm~) BEGIN
 COPY ~faiths_and_powers/kits/multiclass/499_shambarb/d5shamb.itm~ ~override~		//	learn spells .itm
  SAY NAME1 @49911
  SAY NAME2 @49911
  SAY UNIDENTIFIED_DESC @49912
  SAY IDENTIFIED_DESC @49912
  LPF ALTER_ITEM_HEADER INT_VAR header = 1 target = 7 speed = 0 STR_VAR icon = ~d5nshdn~ END
  LPF ALTER_ITEM_HEADER INT_VAR header = 2 target = 7 speed = 0 STR_VAR icon = ~d5nshdi~ END
  LPF ADD_ITEM_EFFECT INT_VAR header = 2 insert_point = 0 opcode = 318 target = 1 parameter1 = shaman_thief_code parameter2 = %kit_is_row% timing = 0 duration = 0 STR_VAR resource = EVAL ~%SOURCE_RES%~ END
  LPF ALTER_ITEM_HEADER INT_VAR header = 3 target = 7 speed = 0 STR_VAR icon = ~spcl919b~ END
END

OUTER_INNER_PATCH ~1~ BEGIN
  WRITE_BYTE 0 0x09
  READ_ASCII 0 tab (1)  // 0x09, tab
  WRITE_BYTE 0 0x0d
  READ_ASCII 0 mnl (1)  // 0x0d, Mac
END
LAF ~ADD_ITEM_TOOLTIPS~ STR_VAR item = ~d5shamb~ tooltips = ~@49921 @49924 @49911~ END

ACTION_IF !(FILE_EXISTS_IN_GAME ~d5shba1.spl~) BEGIN
 COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shba1.spl~				//	initialize shaman abilities
  SAY NAME1 @49950
  SAY UNIDENTIFIED_DESC @49950
  WRITE_SHORT 0x1c 4
  LPF ALTER_SPELL_HEADER INT_VAR location = 4 target = 5 STR_VAR icon = ~spcl919b~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 143 target = 1 parameter1 = 14 timing = 9 STR_VAR resource = ~d5shamb~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5shotz~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5shfre~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 STR_VAR resource = ~d5shmdn~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdi~ END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 172 target = 1 timing = 9 STR_VAR resource = ~d5shba1~ END
END
ACTION_IF (FILE_EXISTS_IN_GAME ~d5shba1.spl~) BEGIN
  COPY_EXISTING ~d5shba1.spl~ ~override~
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %barb_shaman_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5shba1b~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %ranger_shaman_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5shba1b~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %shaman_thief_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5shba1b~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %shaman_mage_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5shba1b~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 326 target = 1 parameter1 = %shaman_monk_code% parameter2 = %kit_is_row% timing = 1 STR_VAR resource = ~d5shba1b~ END
  COPY ~faiths_and_powers/data/misc/d5_base.spl~ ~override/d5shba1b.spl~			//	initialize shaman abilities
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 143 target = 1 parameter1 = 14 timing = 9 STR_VAR resource = ~d5shamb~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5shotz~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 146 target = 1 parameter2 = 1 timing = 1 STR_VAR resource = ~d5shfre~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdn~ END
	LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter1 = 0 parameter2 = 2 timing = 9 STR_VAR resource = ~d5shmdi~ END
END

APPEND ~d5sham.2da~ ~LEARNSPLS   GA_D5SHBA1  ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        ****        **** ~


//append it all to clab table________________________________________________________
//
ACTION_FOR_EACH kit IN ~d5shmbb~ ~override~
			  		~d5shmrn~ ~override~
			  		~d5shmth~ ~override~
			  		~d5shmma~ ~override~
			  		~d5shmnk~ ~override~ BEGIN
  ACTION_IF (FILE_EXISTS_IN_GAME ~%kit%.2da~) BEGIN
	COPY_EXISTING ~%kit%.2da~ ~override~
	  APPEND_FILE ~override/d5sham.2da~
  END
END


//QD_MULTICLASS______________________________________________________________________
//
ACTION_IF FILE_EXISTS_IN_GAME ~d5shmbb.2da~ BEGIN
  LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_BARB_SHAMAN~ 
		kit_clab = ~d5shmbb~
		base_class = ~P~
  END
END 
ACTION_IF FILE_EXISTS_IN_GAME ~d5shmrn.2da~ BEGIN
  LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_RANGER~ 
		kit_clab = ~d5shmrn~
		base_class = ~P~
  END
END 
ACTION_IF FILE_EXISTS_IN_GAME ~d5shmth.2da~ BEGIN
  LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_THIEF~ 
		kit_clab = ~d5shmth~
		base_class = ~P~
  END
END 
ACTION_IF FILE_EXISTS_IN_GAME ~d5shmma.2da~ BEGIN
  LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_MAGE~ 
		kit_clab = ~d5shmma~
		base_class = ~P~
  END
END 
ACTION_IF FILE_EXISTS_IN_GAME ~d5shmnk.2da~ BEGIN
  LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_MONK~ 
		kit_clab = ~d5shmnk~
		base_class = ~P~
  END
  LAF qd_multiclass
	STR_VAR
		kit_name = ~D5_SHAMAN_MONK~ 
		kit_clab = ~QDMONK_C~
		base_class = ~T~
  END
END 


//___________________________________________________________________________________

END	//	end multisham function


////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////


//__________________________________________________________________________________
//__________________________________________________________________________________
//
//							MULTI SHAMAN STRONGHOLDS
//__________________________________________________________________________________
//__________________________________________________________________________________


DEFINE_ACTION_FUNCTION multi_shaman_strongholds BEGIN

ACTION_IF GAME_IS ~bg2ee eet~ BEGIN

<<<<<<<< d5/cechall_.d
EXTEND_BOTTOM CECHALLE 2

 IF ~LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	!Global("GaveTitle","LOCALS",1)
	OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN REPLY #55515  DO ~ClearAllActions()

StartCutSceneMode()

StartCutSceneEx("Cut63a",FALSE)

~ EXIT

 IF ~LevelLT(Player1,14)
	Global("GreatDruid","GLOBAL",0)
	!Global("GaveTitle","LOCALS",1)
	OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN REPLY #58673  EXIT
END

EXTEND_BOTTOM CECHALLE 4
  IF ~  Global("CerndChallenge","GLOBAL",0)
	Global("PlayerHasStronghold","GLOBAL",0)
	OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN DO ~SetGlobal("SPRITE_IS_DEADFaldorn","GLOBAL",1)
SetGlobal("SPRITE_IS_DEADcefaldor","GLOBAL",1)
SetNumTimesTalkedTo(1)
~ GOTO 7
END
>>>>>>>> 
COMPILE ~d5/cechall_.d~

<<<<<<<< d5/cefaldo_.d
EXTEND_BOTTOM CEFALDOR 2

  IF ~See(Player1)
	!StateCheck(Player1,STATE_SLEEPING)
	OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN REPLY #9621  GOTO 13

  IF ~ !Name("Jaheira",Player2)
	!Name("Cernd",Player2)
	See(Player2)
	!StateCheck(Player2,STATE_SLEEPING)
	OR(4)
	  Kit(Player2,D5_BARB_SHAMAN)
	  Kit(Player2,D5_SHAMAN_RANGER)
	  Kit(Player2,D5_SHAMAN_THIEF)
	  Kit(Player2,D5_SHAMAN_MAGE)
~ THEN REPLY #9948  GOTO 22

  IF ~ !Name("Jaheira",Player3)
	!Name("Cernd",Player3)
	See(Player3)
	!StateCheck(Player3,STATE_SLEEPING)
	OR(4)
	  Kit(Player3,D5_BARB_SHAMAN)
	  Kit(Player3,D5_SHAMAN_RANGER)
	  Kit(Player3,D5_SHAMAN_THIEF)
	  Kit(Player3,D5_SHAMAN_MAGE)
~ THEN REPLY #9952  GOTO 22

  IF ~ !Name("Jaheira",Player4)
	!Name("Cernd",Player4)
	See(Player4)
	!StateCheck(Player4,STATE_SLEEPING)
	OR(4)
	  Kit(Player4,D5_BARB_SHAMAN)
	  Kit(Player4,D5_SHAMAN_RANGER)
	  Kit(Player4,D5_SHAMAN_THIEF)
	  Kit(Player4,D5_SHAMAN_MAGE)
~ THEN REPLY #9953  GOTO 22

  IF ~ !Name("Jaheira",Player5)
	!Name("Cernd",Player5)
	See(Player5)
	!StateCheck(Player5,STATE_SLEEPING)
	OR(4)
	  Kit(Player5,D5_BARB_SHAMAN)
	  Kit(Player5,D5_SHAMAN_RANGER)
	  Kit(Player5,D5_SHAMAN_THIEF)
	  Kit(Player5,D5_SHAMAN_MAGE)
~ THEN REPLY #9954  GOTO 22

  IF ~ !Name("Jaheira",Player6)
	!Name("Cernd",Player6)
	See(Player6)
	!StateCheck(Player6,STATE_SLEEPING)
	OR(4)
	  Kit(Player6,D5_BARB_SHAMAN)
	  Kit(Player6,D5_SHAMAN_RANGER)
	  Kit(Player6,D5_SHAMAN_THIEF)
	  Kit(Player6,D5_SHAMAN_MAGE)
~ THEN REPLY #9955  GOTO 22
END

EXTEND_BOTTOM CEFALDOR 5

  IF ~ OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN REPLY #9866  DO ~SetGlobal("TalkedFaldor1","GLOBAL",1)
~ GOTO 0
END
>>>>>>>> 
COMPILE ~d5/cefaldo_.d~

<<<<<<<< d5/druidad_.d
EXTEND_BOTTOM DRUIDAD 0

  IF ~ LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN GOTO 1
END

EXTEND_BOTTOM DRUIDAD 10
  IF ~ LevelGT(Player1,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player1,D5_BARB_SHAMAN)
	  Kit(Player1,D5_SHAMAN_RANGER)
	  Kit(Player1,D5_SHAMAN_THIEF)
	  Kit(Player1,D5_SHAMAN_MAGE)
~ THEN GOTO 11

  IF ~ False()
	LevelGT(Player2,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player2,D5_BARB_SHAMAN)
	  Kit(Player2,D5_SHAMAN_RANGER)
	  Kit(Player2,D5_SHAMAN_THIEF)
	  Kit(Player2,D5_SHAMAN_MAGE)
~ THEN GOTO 12

  IF ~ False()
	LevelGT(Player3,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player3,D5_BARB_SHAMAN)
	  Kit(Player3,D5_SHAMAN_RANGER)
	  Kit(Player3,D5_SHAMAN_THIEF)
	  Kit(Player3,D5_SHAMAN_MAGE)
~ THEN GOTO 13

  IF ~ False()
	LevelGT(Player4,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player4,D5_BARB_SHAMAN)
	  Kit(Player4,D5_SHAMAN_RANGER)
	  Kit(Player4,D5_SHAMAN_THIEF)
	  Kit(Player4,D5_SHAMAN_MAGE)
~ THEN GOTO 14

  IF ~ False()
	LevelGT(Player5,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player5,D5_BARB_SHAMAN)
	  Kit(Player5,D5_SHAMAN_RANGER)
	  Kit(Player5,D5_SHAMAN_THIEF)
	  Kit(Player5,D5_SHAMAN_MAGE)
~ THEN GOTO 15

  IF ~ False()
	LevelGT(Player6,13)
	Global("GreatDruid","GLOBAL",0)
	OR(4)
	  Kit(Player6,D5_BARB_SHAMAN)
	  Kit(Player6,D5_SHAMAN_RANGER)
	  Kit(Player6,D5_SHAMAN_THIEF)
	  Kit(Player6,D5_SHAMAN_MAGE)
~ THEN GOTO 16
END
>>>>>>>> 
COMPILE ~d5/druidad_.d~

END

END // end function
//__________________________________________________________________________________


